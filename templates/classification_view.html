<!DOCTYPE html>
<html>
<head>
    <title>BattyCoda - Vocalization Classification</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        html, body {
            max-width: 100%;
            overflow-x: hidden;
        }
    </style>
</head>
<body>
<div class="header">
    <h1>BattyCoda</h1>
    <p>Animal Vocalization Analysis Tool</p>
</div>

{% if current_user.is_authenticated %}
<div class="nav-container">
    <div class="nav-links">
        <a href="{{ url_for('home') }}">Home</a>
        <a href="/battycoda/home/{{ current_user.username }}/">My Files</a>
    </div>
    <div class="user-info">
        <span>Logged in as: <strong>{{ current_user.username }}</strong></span>
        <a href="{{ url_for('auth.profile') }}" style="margin-left: 15px; margin-right: 15px;">Profile</a>
        <a href="/logout" class="button">Logout</a>
    </div>
</div>
{% endif %}

<form method="post">

<div style="text-align: center; margin-bottom: 15px;">
    <label for="user_name">User:</label>
    <input required type="text" id="user_name" name="user_name" value="{{data.user_name}}">
</div>

<div class="grid-container">
    <!-- Small spectrogram section -->
    <div class="spectrogram-small">
        <h3>Spectrogram: {{data.currentcall}} of {{data.totalcalls}} calls</h3>
        {{ data.spectrogram|debug_image|safe }}
    </div>
    
    <!-- Controls section -->
    <div class="controls">
        <div>
            <label for="contrast">Contrast:</label>
            <input required type="text" id="contrast" name="contrast" 
                onchange="document.getElementById('submitbutton_{{data.currentcall}}').disabled=isNaN(Number(document.getElementById('contrast').value))"
                value="{{data.contrast}}">
        </div>
        <div style="margin-top: 10px;">
            <label for="loudness">Loudness:</label>
            <input required type="text" id="loudness" name="loudness"
                onchange="document.getElementById('submitbutton_{{data.currentcall}}').disabled=isNaN(Number(document.getElementById('loudness').value))"
                value="{{data.loudness}}">
        </div>
        <div style="margin-top: 10px;">
            <label for="main">Main channel:</label>
            <input required type="number" min="1" max="{{ data.max_main }}" id="main" name="main" value="{{data.main}}">
        </div>
        
        <div class="button-group">
            <input id='submitbutton_{{data.currentcall}}' type="submit" name='submitbutton_{{data.currentcall}}' value="Next Call">
            <input id='updatebutton' type="submit" name="updatebutton" value="Update">
            <input id='undobutton' type="submit" name="undobutton" value="Undo">
        </div>
        
        <div style="margin-top: 10px; text-align: center;">
            {{ data.backlink }}
        </div>
    </div>
    
    <!-- Call type section -->
    <div class="call-type">
        <h3>Vocalization Classification</h3>
        
        <div style="margin-bottom: 10px;">
            <input type="radio" id="correct" name="type_call" value="correct">
            <label for="correct">Correctly classified</label>
        </div>
        
        <div>
            {{ data.species }}
        </div>
        
        <div style="margin-top: 10px;">
            <input type="radio" id="Unsure" name="type_call" value="Unsure">
            <label for="Unsure">Unsure</label>
        </div>
        
        <div style="margin-top: 10px;">
            <input type="radio" id="Other" name="type_call">
            <label for="Other">Other:</label>
            <input type="text" id="Other" name="type_call" style="margin-top: 5px;">
        </div>
    </div>
    
    <!-- Large spectrogram section -->
    <div class="spectrogram-large">
        <h3>Detailed View</h3>
        {{ data.spectrogram_large|debug_image|safe }}
    </div>
    
    <!-- Confidence section -->
    <div class="confidence">
        <h3>Classification Confidence</h3>
        <p>Confidence: <strong>{{data.confidence}}</strong></p>
        
        <div style="margin-top: 15px;">
            <label for="limit_confidence">If future confidence is below this ask:</label>
            <input required type="number" min="0" max="100" step="1" id="limit_confidence" 
                name="limit_confidence" value="{{data.limit_confidence}}">
        </div>
        
        <div style="margin-top: 15px;">
            <p>Species template:</p>
            {{ data.jpgname|debug_image|safe }}
        </div>
    </div>
    
    <!-- Audio section -->
    <div class="audio-section">
        <h3>Audio Playback</h3>
        <div style="margin-top: 10px;">
            <p>Short clip:</p>
            <audio controls src="{{ data.audiolink }}" preload="none">
                Your browser does not support the audio element.
            </audio>
        </div>
        
        <div style="margin-top: 15px;">
            <p>Long clip:</p>
            <audio controls src="{{ data.long_audiolink }}" preload="none">
                Your browser does not support the audio element.
            </audio>
        </div>
    </div>
    
    <!-- Other channels section -->
    <div class="others">
        <h3>Other Channels</h3>
        <div class="other-channels-content">
            {{ data.others }}
        </div>
    </div>
</div>

</form>
<script>
    window.onload = function() {
        // Focus the radio button for the classified call type
        if (document.getElementById("{{data.focused}}")) {
            document.getElementById("{{data.focused}}").focus();
        } else {
            console.warn("Element with ID '{{data.focused}}' not found");
        }
        
        // Check for broken images and log them
        var images = document.querySelectorAll('img');
        var brokenCount = 0;
        
        images.forEach(function(img) {
            img.addEventListener('error', function() {
                brokenCount++;
                console.error('Broken image: ' + img.src);
                document.getElementById('debug-status').textContent = 'Found ' + brokenCount + ' broken images';
                document.getElementById('debug-status').style.color = 'red';
                
                // Add fallback image and apply class for styling
                this.src = '/static/broken_image.png';
                
                // Add the broken-image class to the parent container
                var container = this.closest('.image-container');
                if (container) {
                    container.classList.add('broken-image');
                }
                
                // Show debug info for this image
                var container = this.closest('.image-container');
                if (container) {
                    var debugInfo = container.querySelector('.debug-info');
                    if (debugInfo) {
                        debugInfo.style.display = 'block';
                    }
                }
            });
        });
    }
    
    // Toggle debug mode
    function toggleDebug() {
        var debugInfo = document.querySelectorAll('.debug-info');
        var isVisible = debugInfo.length > 0 && debugInfo[0].style.display === 'block';
        
        debugInfo.forEach(function(info) {
            info.style.display = isVisible ? 'none' : 'block';
        });
        
        document.getElementById('debug-button').textContent = 
            isVisible ? 'Show Debug Info' : 'Hide Debug Info';
    }
</script>

<!-- Debug controls -->
<div class="debug-controls">
    <button id="debug-button" onclick="toggleDebug()">Show Debug Info</button>
    <span id="debug-status" style="color: white; margin-left: 10px;">No broken images found</span>
</div>

{% with messages = get_flashed_messages() %}
{% if messages %}
<div class="flash-messages">
    {% for message in messages %}
    <div class="flash-message">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}
</body>
</html>