document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const profileImageUpload = document.getElementById('profile_image_upload');
    const uploadImageBtn = document.getElementById('upload-image-btn');
    const removeImageBtn = document.getElementById('remove-image-btn');
    const updateEmailBtn = document.getElementById('update-email-btn');
    const emailInput = document.getElementById('id_email');
    const updateManagementFeaturesBtn = document.getElementById('update-management-features-btn');
    const managementFeaturesCheckbox = document.getElementById('id_management_features_enabled');
    const imageUploadStatus = document.getElementById('image-upload-status');
    const emailUpdateStatus = document.getElementById('email-update-status');
    const managementFeaturesStatus = document.getElementById('management-features-status');
    
    // Function to show status messages
    function showStatus(element, message, isSuccess) {
        element.innerHTML = `<div class="alert alert-${isSuccess ? 'success' : 'danger'} py-2">${message}</div>`;
        
        // Clear message after 5 seconds
        setTimeout(() => {
            element.innerHTML = '';
        }, 5000);
    }
    
    // Handle profile image upload
    uploadImageBtn.addEventListener('click', function() {
        if (!profileImageUpload.files.length) {
            showStatus(imageUploadStatus, 'Please select an image file first.', false);
            return;
        }
        
        const file = profileImageUpload.files[0];
        
        // Validate file type
        if (!file.type.match('image.*')) {
            showStatus(imageUploadStatus, 'Please select a valid image file.', false);
            return;
        }
        
        // Create FormData object and append the file
        const formData = new FormData();
        formData.append('profile_image', file);
        formData.append('action', 'upload_image');
        
        // Show loading state
        uploadImageBtn.disabled = true;
        uploadImageBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-1"></i> Uploading...';
        
        // Send AJAX request
        fetch('{% url "battycoda_app:update_profile_ajax" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStatus(imageUploadStatus, data.message, true);
                
                // Update the profile image on the page
                const imageDisplay = document.getElementById('profile-image-display');
                imageDisplay.innerHTML = `<img src="${data.image_url}?v=${new Date().getTime()}" alt="Profile Image" class="img-fluid rounded-circle" style="width: 150px; height: 150px; object-fit: cover;">`;
                
                // Add remove button if it doesn't exist
                if (!removeImageBtn && data.has_image) {
                    const removeBtn = document.createElement('button');
                    removeBtn.id = 'remove-image-btn';
                    removeBtn.className = 'btn btn-sm btn-outline-danger ml-2';
                    removeBtn.innerHTML = '<i class="fa fa-trash me-1"></i> Remove Image';
                    document.querySelector('.mt-2').appendChild(removeBtn);
                    
                    // Add event listener to newly created button
                    removeBtn.addEventListener('click', handleRemoveImage);
                }
                
                // Update navbar profile image if it exists
                const navbarProfileImage = document.querySelector('.nav.navbar-nav a.dropdown-toggle img');
                if (navbarProfileImage) {
                    navbarProfileImage.src = data.image_url + '?v=' + new Date().getTime();
                }
                
                // Clear the file input
                profileImageUpload.value = '';
            } else {
                showStatus(imageUploadStatus, data.message || 'An error occurred.', false);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showStatus(imageUploadStatus, 'An error occurred while uploading the image.', false);
        })
        .finally(() => {
            // Reset button state
            uploadImageBtn.disabled = false;
            uploadImageBtn.innerHTML = '<i class="fa fa-upload me-1"></i> Upload Image';
        });
    });
    
    // Handle remove profile image
    function handleRemoveImage() {
        if (!confirm('Are you sure you want to remove your profile image?')) {
            return;
        }
        
        // Create FormData and append action
        const formData = new FormData();
        formData.append('action', 'remove_image');
        
        // Show loading state
        if (removeImageBtn) {
            removeImageBtn.disabled = true;
            removeImageBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-1"></i> Removing...';
        }
        
        // Send AJAX request
        fetch('{% url "battycoda_app:update_profile_ajax" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStatus(imageUploadStatus, data.message, true);
                
                // Update the profile image display
                const imageDisplay = document.getElementById('profile-image-display');
                imageDisplay.innerHTML = `
                    <div class="profile-placeholder rounded-circle d-flex align-items-center justify-content-center bg-primary" style="width: 150px; height: 150px; margin: 0 auto;">
                        <span class="s7-user text-white" style="font-size: 4rem;"></span>
                    </div>
                `;
                
                // Remove the remove button
                if (removeImageBtn) {
                    removeImageBtn.remove();
                }
                
                // Update navbar image
                const navbarProfileImage = document.querySelector('.nav.navbar-nav a.dropdown-toggle img');
                if (navbarProfileImage) {
                    const navbarUserIcon = navbarProfileImage.parentNode;
                    navbarUserIcon.innerHTML = '<span class="icon s7-user"></span>';
                }
            } else {
                showStatus(imageUploadStatus, data.message || 'An error occurred.', false);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showStatus(imageUploadStatus, 'An error occurred while removing the image.', false);
        });
    }
    
    // Add event listener to remove image button if it exists
    if (removeImageBtn) {
        removeImageBtn.addEventListener('click', handleRemoveImage);
    }
    
    // Handle email update
    updateEmailBtn.addEventListener('click', function() {
        const email = emailInput.value.trim();
        
        if (!email) {
            showStatus(emailUpdateStatus, 'Please enter a valid email address.', false);
            return;
        }
        
        // Create FormData and append email
        const formData = new FormData();
        formData.append('email', email);
        formData.append('action', 'update_email');
        
        // Show loading state
        updateEmailBtn.disabled = true;
        updateEmailBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-1"></i> Updating...';
        
        // Send AJAX request
        fetch('{% url "battycoda_app:update_profile_ajax" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStatus(emailUpdateStatus, data.message, true);
            } else {
                showStatus(emailUpdateStatus, data.message || 'An error occurred.', false);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showStatus(emailUpdateStatus, 'An error occurred while updating email.', false);
        })
        .finally(() => {
            // Reset button state
            updateEmailBtn.disabled = false;
            updateEmailBtn.innerHTML = '<i class="fa fa-save me-1"></i> Update Email';
        });
    });
    
    // Handle management features update
    updateManagementFeaturesBtn.addEventListener('click', function() {
        const isEnabled = managementFeaturesCheckbox.checked;
        
        // Create FormData and append management features setting
        const formData = new FormData();
        formData.append('management_features_enabled', isEnabled);
        formData.append('action', 'update_management_features');
        
        // Show loading state
        updateManagementFeaturesBtn.disabled = true;
        updateManagementFeaturesBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-1"></i> Updating...';
        
        // Send AJAX request
        fetch('{% url "battycoda_app:update_profile_ajax" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStatus(managementFeaturesStatus, data.message, true);
            } else {
                showStatus(managementFeaturesStatus, data.message || 'An error occurred.', false);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showStatus(managementFeaturesStatus, 'An error occurred while updating management features.', false);
        })
        .finally(() => {
            // Reset button state
            updateManagementFeaturesBtn.disabled = false;
            updateManagementFeaturesBtn.innerHTML = '<i class="fa fa-save me-1"></i> Update Management Features';
        });
    });
});

// Function to copy API key to clipboard
function copyApiKey() {
    const apiKeyInput = document.getElementById('api-key-display');
    apiKeyInput.select();
    apiKeyInput.setSelectionRange(0, 99999); // For mobile devices
    
    try {
        document.execCommand('copy');
        
        // Show success message
        const statusDiv = document.getElementById('api-key-status');
        statusDiv.innerHTML = '<div class="alert alert-success py-2">API key copied to clipboard!</div>';
        
        // Clear message after 3 seconds
        setTimeout(() => {
            statusDiv.innerHTML = '';
        }, 3000);
    } catch (err) {
        console.error('Failed to copy: ', err);
        
        // Show error message
        const statusDiv = document.getElementById('api-key-status');
        statusDiv.innerHTML = '<div class="alert alert-warning py-2">Please manually copy the API key.</div>';
        
        // Clear message after 3 seconds
        setTimeout(() => {
            statusDiv.innerHTML = '';
        }, 3000);
    }
}
</script>
