{% extends 'base.html' %}

{% block title %}Edit Profile | BattyCoda{% endblock %}

{% block extra_css %}
<!-- Theme preview styles now in themes.css -->
{% endblock %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header bg-light">
        <h2 class="mb-0">Edit Profile</h2>
    </div>
    <div class="card-body">
    
    <div id="profile-form">
        {% csrf_token %}
        
        <div class="row mb-4">
            <div class="col-md-4 text-center">
                <div class="profile-image-container mb-3">
                    <div id="profile-image-display">
                        {% if profile.profile_image %}
                            <img src="{{ profile.profile_image.url }}?v={{ random }}" alt="Profile Image" class="img-fluid rounded-circle" style="width: 150px; height: 150px; object-fit: cover;">
                        {% else %}
                            <div class="profile-placeholder rounded-circle d-flex align-items-center justify-content-center bg-primary" style="width: 150px; height: 150px; margin: 0 auto;">
                                <span class="s7-user text-white" style="font-size: 4rem;"></span>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="profile_image_upload" class="form-label">Profile Image:</label>
                    <input type="file" name="profile_image" id="profile_image_upload" accept="image/*" class="form-control">
                    <small class="text-muted d-block mt-1">Select an image to update your profile picture</small>
                    
                    <div class="mt-2">
                        <button type="button" id="upload-image-btn" class="btn btn-sm btn-primary">
                            <i class="fa fa-upload me-1"></i> Upload Image
                        </button>
                        
                        {% if profile.profile_image %}
                            <button type="button" id="remove-image-btn" class="btn btn-sm btn-outline-danger ml-2">
                                <i class="fa fa-trash me-1"></i> Remove Image
                            </button>
                        {% endif %}
                    </div>
                    
                    <div id="image-upload-status" class="mt-2"></div>
    {% include "auth/includes/profile_image.html" %}
    {% include "auth/includes/account_settings.html" %}
    {% include "auth/includes/api_keys.html" %}
        .catch(error => {
            console.error('Error:', error);
            showStatus(managementFeaturesStatus, 'An error occurred while updating management features.', false);
        })
        .finally(() => {
            // Reset button state
            updateManagementFeaturesBtn.disabled = false;
            updateManagementFeaturesBtn.innerHTML = '<i class="fa fa-save me-1"></i> Update Management Features';
        });
    });
});

// Function to copy API key to clipboard
function copyApiKey() {
    const apiKeyInput = document.getElementById('api-key-display');
    apiKeyInput.select();
    apiKeyInput.setSelectionRange(0, 99999); // For mobile devices
    
    try {
        document.execCommand('copy');
        
        // Show success message
        const statusDiv = document.getElementById('api-key-status');
        statusDiv.innerHTML = '<div class="alert alert-success py-2">API key copied to clipboard!</div>';
        
        // Clear message after 3 seconds
        setTimeout(() => {
            statusDiv.innerHTML = '';
        }, 3000);
    } catch (err) {
        console.error('Failed to copy: ', err);
        
        // Show error message
        const statusDiv = document.getElementById('api-key-status');
        statusDiv.innerHTML = '<div class="alert alert-warning py-2">Please manually copy the API key.</div>';
        
        // Clear message after 3 seconds
        setTimeout(() => {
            statusDiv.innerHTML = '';
        }, 3000);
    }
}
</script>
{% endblock %}