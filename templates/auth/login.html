{% extends 'base.html' %}

{% block title %}Login | BattyCoda{% endblock %}

{% block content %}
<div class="section">
    <h2>Login</h2>
    <form method="post" action="{% url 'battycoda_app:login' %}">
        {% csrf_token %}
        
        <div style="margin-bottom: 15px;">
            <label for="id_username" style="display: block; margin-bottom: 5px;">Username or Email:</label>
            {% if username_or_email %}
                <input type="text" name="username" id="id_username" value="{{ username_or_email }}" required class="input-field">
            {% else %}
                {{ form.username }}
            {% endif %}
            {% if form.username.errors %}
            <span style="color: #e57373; font-size: 0.9em;">
                {{ form.username.errors }}
            </span>
            {% endif %}
        </div>
        
        <div style="margin-bottom: 15px;">
            <label for="id_password" style="display: block; margin-bottom: 5px;">Password:</label>
            {{ form.password }}
            {% if form.password.errors %}
            <span style="color: #e57373; font-size: 0.9em;">
                {{ form.password.errors }}
            </span>
            {% endif %}
        </div>
        
        {% if form.non_field_errors %}
        <div style="margin-bottom: 15px; color: #e57373;">
            {{ form.non_field_errors }}
        </div>
        {% endif %}
        
        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button type="submit" class="button" style="flex: 1; padding: 10px 0;">Login with Password</button>
            <a href="{% url 'battycoda_app:request_login_code' %}" id="codeLoginBtn" class="button btn-outline-secondary" style="flex: 1; padding: 10px 0; text-align: center; text-decoration: none; border-radius: 3px;">Login with Code</a>
        </div>
        
        <script>
            // Script to pass username to the login code page
            document.addEventListener('DOMContentLoaded', function() {
                const codeLoginBtn = document.getElementById('codeLoginBtn');
                const usernameField = document.getElementById('id_username');
                
                codeLoginBtn.addEventListener('click', function(e) {
                    if (usernameField && usernameField.value) {
                        e.preventDefault();
                        const username = encodeURIComponent(usernameField.value);
                        window.location.href = "{% url 'battycoda_app:request_login_code' %}?username=" + username;
                    }
                });
            });
        </script>
    </form>
    
    <div style="margin-top: 20px;">
        <p>Don't have an account? <a href="{% url 'battycoda_app:register' %}" id="registerLink">Register</a></p>
        <p>Forgot your password? <a href="{% url 'battycoda_app:password_reset_request' %}" id="resetPasswordLink">Reset Password</a></p>
    </div>
    
    <script>
        // Script to pass username to other pages
        document.addEventListener('DOMContentLoaded', function() {
            const resetPasswordLink = document.getElementById('resetPasswordLink');
            const registerLink = document.getElementById('registerLink');
            const usernameField = document.getElementById('id_username');
            
            // Handle password reset link
            resetPasswordLink.addEventListener('click', function(e) {
                if (usernameField && usernameField.value) {
                    e.preventDefault();
                    const username = encodeURIComponent(usernameField.value);
                    window.location.href = "{% url 'battycoda_app:password_reset_request' %}?username=" + username;
                }
            });
            
            // Handle register link
            registerLink.addEventListener('click', function(e) {
                if (usernameField && usernameField.value) {
                    e.preventDefault();
                    const identifier = usernameField.value;
                    
                    // Check if it looks like an email
                    if (identifier.includes('@')) {
                        // Transfer as email
                        window.location.href = "{% url 'battycoda_app:register' %}?email=" + encodeURIComponent(identifier);
                    } else {
                        // Transfer as username
                        window.location.href = "{% url 'battycoda_app:register' %}?username=" + encodeURIComponent(identifier);
                    }
                }
            });
        });
    </script>
</div>
{% endblock %}