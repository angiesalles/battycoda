{% extends 'base.html' %}

{% block title %}Classification | BattyCoda{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1 class="mb-4">Classification</h1>
            <p class="lead">View and manage your automated classification runs and custom classifiers.</p>

            <!-- Navigation tabs -->
            <ul class="nav nav-tabs" id="classificationTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="runs-tab" data-bs-toggle="tab" data-bs-target="#runs-content" type="button" role="tab" aria-controls="runs-content" aria-selected="true">
                        <i class="fas fa-bolt me-1"></i> Classification Runs
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="classifiers-tab" data-bs-toggle="tab" data-bs-target="#classifiers-content" type="button" role="tab" aria-controls="classifiers-content" aria-selected="false">
                        <i class="fas fa-brain me-1"></i> Custom Classifiers
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="available-tab" data-bs-toggle="tab" data-bs-target="#available-content" type="button" role="tab" aria-controls="available-content" aria-selected="false">
                        <i class="fas fa-list me-1"></i> Available Classifiers
                    </button>
                </li>
            </ul>

            <div class="tab-content mt-4" id="classificationTabsContent">
                <!-- Runs Tab Content -->
                <div class="tab-pane fade show active" id="runs-content" role="tabpanel" aria-labelledby="runs-tab">
                    {% include 'classification/includes/runs_tab.html' %}
                </div>

                <!-- Classifiers Tab Content -->
                <div class="tab-pane fade" id="classifiers-content" role="tabpanel" aria-labelledby="classifiers-tab">
                    {% include 'classification/includes/classifiers_tab.html' %}
                </div>

                <!-- Available Classifiers Tab Content -->
                <div class="tab-pane fade" id="available-content" role="tabpanel" aria-labelledby="available-tab">
                    {% include 'classification/includes/available_tab.html' %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tabs
    var tabs = document.querySelectorAll('button[data-bs-toggle="tab"]')
    tabs.forEach(function(tab) {
        tab.addEventListener('click', function (event) {
            event.preventDefault();

            // Hide all tab panes
            document.querySelectorAll('.tab-pane').forEach(function(pane) {
                pane.classList.remove('show', 'active');
            });

            // Deactivate all tabs
            document.querySelectorAll('.nav-link').forEach(function(navLink) {
                navLink.classList.remove('active');
                navLink.setAttribute('aria-selected', 'false');
            });

            // Activate clicked tab
            this.classList.add('active');
            this.setAttribute('aria-selected', 'true');

            // Show the target pane
            var target = document.querySelector(this.dataset.bsTarget);
            if (target) {
                target.classList.add('show', 'active');
            }
        });
    });

    // Auto-refresh progress bars for in-progress runs
    const inProgressRuns = document.querySelectorAll('tr[data-run-id]:has(.badge.bg-info)');

    if (inProgressRuns.length > 0) {
        setInterval(function() {
            inProgressRuns.forEach(function(row) {
                const runId = row.getAttribute('data-run-id');
                if (!runId) return;

                fetch(`/classification/runs/${runId}/status/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const progressBar = row.querySelector('.progress-bar');
                            const statusBadge = row.querySelector('.badge');

                            progressBar.style.width = `${data.progress}%`;
                            progressBar.setAttribute('aria-valuenow', data.progress);
                            progressBar.textContent = `${data.progress.toFixed(1)}%`;

                            if (data.status !== 'in_progress') {
                                window.location.reload(); // Refresh when status changes
                            }
                        }
                    });
            });
        }, 5000); // Check every 5 seconds
    }

    // Auto-refresh progress bars for training jobs
    const inProgressJobs = document.querySelectorAll('tr[data-job-id]:has(.badge.bg-info)');

    if (inProgressJobs.length > 0) {
        setInterval(function() {
            inProgressJobs.forEach(function(row) {
                const jobId = row.getAttribute('data-job-id');
                if (!jobId) return;

                fetch(`/classification/classifiers/${jobId}/status/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const progressBar = row.querySelector('.progress-bar');
                            const statusBadge = row.querySelector('.badge');

                            progressBar.style.width = `${data.progress}%`;
                            progressBar.setAttribute('aria-valuenow', data.progress);
                            progressBar.textContent = `${data.progress.toFixed(1)}%`;

                            if (data.status !== 'in_progress') {
                                window.location.reload(); // Refresh when status changes
                            }
                        }
                    });
            });
        }, 5000); // Check every 5 seconds
    }
});
</script>
{% endblock %}
