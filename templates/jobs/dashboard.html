{% extends 'base.html' %}
{% load static %}

{% block title %}BattyCoda - Jobs Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/debug.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-clock me-2"></i> Jobs Dashboard</h1>
        <div>
            <button id="refresh-jobs" class="btn btn-outline-primary">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button id="auto-refresh-toggle" class="btn btn-outline-secondary" data-auto="true">
                <i class="fas fa-play"></i> Auto-refresh: ON
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <h5 class="card-title text-primary">
                        <i class="fas fa-scissors"></i> Segmentation
                    </h5>
                    <h3 id="segmentation-count" class="mb-0">{{ segmentation_active_count|default:0 }}</h3>
                    <small class="text-muted">Active Jobs</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-info">
                <div class="card-body text-center">
                    <h5 class="card-title text-info">
                        <i class="fas fa-desktop"></i> Classification
                    </h5>
                    <h3 id="detection-count" class="mb-0">{{ detection_active_count|default:0 }}</h3>
                    <small class="text-muted">Active Jobs</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <h5 class="card-title text-warning">
                        <i class="fas fa-tools"></i> Training
                    </h5>
                    <h3 id="training-count" class="mb-0">{{ training_jobs|length }}</h3>
                    <small class="text-muted">Active Jobs</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-success">
                <div class="card-body text-center">
                    <h5 class="card-title text-success">
                        <i class="fas fa-layer-group"></i> Clustering
                    </h5>
                    <h3 id="clustering-count" class="mb-0">{{ clustering_jobs|length }}</h3>
                    <small class="text-muted">Active Jobs</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-danger">
                <div class="card-body text-center">
                    <h5 class="card-title text-danger">
                        <i class="fas fa-chart-line"></i> Spectrograms
                    </h5>
                    <h3 id="spectrogram-count" class="mb-0">{{ spectrogram_jobs|length }}</h3>
                    <small class="text-muted">Active Jobs</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Jobs Tables -->
    <div class="row">
        {% include "jobs/includes/job_table.html" with jobs=segmentation_jobs title="Segmentation Jobs" icon="fas fa-scissors" detail_url_name="battycoda_app:recording_detail" job_id_param="recording_id" job_type="segmentation" cancel_statuses="pending,in_progress" show_recording=True %}
        {% include "jobs/includes/job_table.html" with jobs=detection_jobs title="Classification Jobs" icon="fas fa-desktop" detail_url_name="battycoda_app:detection_run_detail" job_id_param="run_id" job_type="detection" cancel_statuses="pending,running" show_classifier=True %}
        {% include "jobs/includes/job_table.html" with jobs=training_jobs title="Training Jobs" icon="fas fa-tools" detail_url_name="battycoda_app:classifier_training_job_detail" job_id_param="job_id" job_type="training" cancel_statuses="pending,running" %}
        {% include "jobs/includes/job_table.html" with jobs=clustering_jobs title="Clustering Jobs" icon="fas fa-layer-group" detail_url_name="battycoda_app:clustering_run_detail" job_id_param="run_id" job_type="clustering" cancel_statuses="pending,running" %}
        {% include "jobs/includes/spectrogram_table.html" %}
    </div>
    {% if not segmentation_jobs and not detection_jobs and not training_jobs and not clustering_jobs and not spectrogram_jobs %}
    <div class="text-center py-5">
        <i class="fas fa-clock text-muted" style="font-size: 4rem;"></i>
        <h3 class="text-muted mt-3">No Jobs Found</h3>
        <p class="text-muted">There are currently no active or recent jobs to display.</p>
        <div class="mt-4">
            <a href="{% url 'battycoda_app:batch_segmentation' %}" class="btn btn-primary me-2">
                <i class="fas fa-scissors me-1"></i> Start Segmentation
            </a>
            <a href="{% url 'battycoda_app:classification_home' %}" class="btn btn-info me-2">
                <i class="fas fa-desktop me-1"></i> Run Classification
            </a>
            <a href="{% url 'battycoda_app:clustering_dashboard' %}" class="btn btn-success">
                <i class="fas fa-layer-group me-1"></i> Start Clustering
            </a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<!-- Page data for jobs dashboard -->
<div id="jobs-page-data"
     data-job-status-url="{% url 'battycoda_app:job_status_api' %}"
     data-cancel-job-url-template="{% url 'battycoda_app:cancel_job' job_type='PLACEHOLDER' job_id=0 %}"
     data-csrf-token="{{ csrf_token }}"
     hidden></div>

<script src="{% static 'js/datetime_formatter.js' %}"></script>
<script src="{% static 'js/pages/jobs-dashboard.js' %}"></script>
{% endblock %}