{% extends 'base.html' %}

{% block title %}Add New Species - BattyCoda{% endblock %}

{% block extra_css %}
<style>
    button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="section">
    <h2>Add New Species</h2>
    
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div style="margin-bottom: 15px;">
            <label for="id_name" style="display: block; margin-bottom: 5px;">Name: <span style="color: #e57373;">*</span></label>
            {{ form.name }}
            <p style="font-size: 0.8em; margin-top: 3px; color: #999;">Species name must be unique within your group</p>
            <div id="name-error-field" style="color: #e57373; margin-top: 5px; display: none;"></div>
            {% if form.name.errors %}
            <div style="color: #e57373; margin-top: 5px;">
                {% for error in form.name.errors %}
                {{ error }}
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <!-- Scientific Name field removed -->
        
        <div style="margin-bottom: 15px;">
            <label for="id_description" style="display: block; margin-bottom: 5px;">Description:</label>
            {{ form.description }}
            {% if form.description.errors %}
            <div style="color: #e57373; margin-top: 5px;">
                {% for error in form.description.errors %}
                {{ error }}
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <div style="margin-bottom: 15px;">
            <label for="id_image" style="display: block; margin-bottom: 5px;">Species Image:</label>
            {{ form.image }}
            {% if form.image.errors %}
            <div style="color: #e57373; margin-top: 5px;">
                {% for error in form.image.errors %}
                {{ error }}
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
{% include "species/includes/basic_form.html" %}
{% include "species/includes/call_types.html" %}
            submitButton.disabled = true;
            return false;
        }
        
        // Check for duplicates
        if (existingSpeciesNames.includes(speciesName)) {
            nameErrorDiv.textContent = `A species with the name "${speciesName}" already exists in your group.`;
            nameErrorDiv.style.display = 'block';
            submitButton.disabled = true;
            return false;
        }
        
        // If we get here, name is valid
        nameErrorDiv.style.display = 'none';
        submitButton.disabled = false;
        return true;
    }
    
    // Check name as soon as the page loads (in case there's a default value)
    validateSpeciesName();
    
    // Check name as user types
    speciesNameInput.addEventListener('input', validateSpeciesName);
    
    // Prevent form submission on Enter key press in text fields
    document.querySelector('form').addEventListener('keydown', function(event) {
        if (event.key === 'Enter' && event.target.tagName === 'INPUT' && event.target.type === 'text') {
            // Let the call inputs handle their own Enter key
            if (event.target === newCallShortName || event.target === newCallLongName) {
                return;
            }
            
            // For other text inputs, prevent form submission
            event.preventDefault();
        }
    });
    
    // Handle form submission
    document.querySelector('form').addEventListener('submit', function(event) {
        // Stop the form submission temporarily
        event.preventDefault();
        
        // Validate name one more time
        if (!validateSpeciesName()) {
            return;
        }
        
        // Make sure the JSON field is up to date - this must happen BEFORE form submission
        updateCallTypesJson();
        
        // Continue with form submission after ensuring data is set
        this.submit();
    });
});
</script>
{% endblock extra_js %}