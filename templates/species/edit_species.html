{% extends 'base.html' %}
{% load static %}

{% block title %}BattyCoda - Edit Species{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'battycoda_app:species_list' %}">Species</a></li>
                <li class="breadcrumb-item"><a href="{% url 'battycoda_app:species_detail' species.id %}">{{ species.name }}</a></li>
                <li class="breadcrumb-item active" aria-current="page">Edit</li>
            </ol>
        </nav>
    </div>

    {% if messages %}
    <div class="messages mb-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Edit Species: {{ species.name }}</h5>
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="row mb-4">
                    <div class="col-md-8">
                        <!-- Basic Information -->
                        <div class="mb-3">
                            <label for="id_name" class="form-label">Name:</label>
                            {{ form.name|safe }}
                            {% if form.name.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.name.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_description" class="form-label">Description:</label>
                            {{ form.description|safe }}
                            {% if form.description.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.description.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <!-- Image Section -->
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="mb-0">Species Image</h6>
                            </div>
                            <div class="card-body">
                                {% if species.image %}
                                <div class="text-center mb-3">
                                    <img src="{{ species.image.url }}" alt="{{ species.name }}" class="img-fluid rounded mb-2" style="max-height: 200px;">
                                </div>
                                {% endif %}
                                <div class="mb-2">
                                    {{ form.image|safe }}
                                </div>
                                <small class="text-muted">Upload a new image to replace the current one</small>
                                {% if form.image.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.image.errors %}
                                    {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Spectrogram Padding Settings -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Spectrogram Padding Settings</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-4">
                            Configure the padding around calls in spectrograms. Padding provides temporal context before and after each call.
                        </p>

                        <div class="row">
                            <div class="col-md-6">
                                <h6>Detail View</h6>
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <label for="id_detail_padding_start_ms" class="form-label">Before (ms):</label>
                                        {{ form.detail_padding_start_ms }}
                                        {% if form.detail_padding_start_ms.help_text %}
                                        <small class="text-muted d-block mt-1">{{ form.detail_padding_start_ms.help_text }}</small>
                                        {% endif %}
                                        {% if form.detail_padding_start_ms.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.detail_padding_start_ms.errors %}
                                            {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-6">
                                        <label for="id_detail_padding_end_ms" class="form-label">After (ms):</label>
                                        {{ form.detail_padding_end_ms }}
                                        {% if form.detail_padding_end_ms.help_text %}
                                        <small class="text-muted d-block mt-1">{{ form.detail_padding_end_ms.help_text }}</small>
                                        {% endif %}
                                        {% if form.detail_padding_end_ms.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.detail_padding_end_ms.errors %}
                                            {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h6>Overview</h6>
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <label for="id_overview_padding_start_ms" class="form-label">Before (ms):</label>
                                        {{ form.overview_padding_start_ms }}
                                        {% if form.overview_padding_start_ms.help_text %}
                                        <small class="text-muted d-block mt-1">{{ form.overview_padding_start_ms.help_text }}</small>
                                        {% endif %}
                                        {% if form.overview_padding_start_ms.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.overview_padding_start_ms.errors %}
                                            {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-6">
                                        <label for="id_overview_padding_end_ms" class="form-label">After (ms):</label>
                                        {{ form.overview_padding_end_ms }}
                                        {% if form.overview_padding_end_ms.help_text %}
                                        <small class="text-muted d-block mt-1">{{ form.overview_padding_end_ms.help_text }}</small>
                                        {% endif %}
                                        {% if form.overview_padding_end_ms.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.overview_padding_end_ms.errors %}
                                            {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Call Types Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Call Types</h5>
                    </div>
                    <div class="card-body">
                        <!-- Hidden field to store call types as JSON (empty = preserve existing calls if JS fails) -->
                        <input type="hidden" id="call_types_json" name="call_types_json" value="">

                        {% if can_modify %}
                        <!-- Import from file section -->
                        <div id="file-import-section" class="mb-4 p-3 bg-light rounded border">
                            <h6 class="mb-2">Import Calls from File</h6>
                            <p class="text-muted small mb-2">Uploading a file will replace any calls you've already added.</p>
                            <div class="row align-items-end mb-2">
                                <div class="col-md-9">
                                    <input type="file" id="calls_file_input" class="form-control">
                                </div>
                                <div class="col-md-3">
                                    <button type="button" id="parse_file_btn" class="btn btn-primary w-100">Parse File</button>
                                </div>
                            </div>
                            <p class="small text-muted mb-0">Upload a text file with call types (one per line, format: short_name,long_name)</p>
                            <div id="file-load-status" class="mt-2"></div>
                        </div>
                        {% endif %}

                        <!-- List of calls -->
                        <div id="calls-container" class="mb-4">
                            <h6 class="mb-3">Call Types List</h6>
                            <div id="calls-table-container">
                                <p class="text-muted text-center fst-italic">No call types added yet.</p>
                            </div>
                        </div>

                        <!-- Add new call form -->
                        <div id="add-call-section" class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Add a New Call Type</h6>
                            </div>
                            <div class="card-body">
                                <div id="add-call-messages"></div>
                                {% if has_classifiers %}
                                <div class="alert alert-warning mb-0">
                                    <i class="fas fa-lock"></i> Call types cannot be modified because this species is used by one or more classifiers.
                                    Classifiers are tied to the call types of their species.
                                </div>
                                {% else %}
                                <p class="text-muted small mb-3">Press Enter in either field to quickly add a call</p>
                                <div class="row mb-3">
                                    <div class="col-md-5">
                                        <label for="new-call-short-name" class="form-label">Short Name</label>
                                        <input type="text" id="new-call-short-name" class="form-control" placeholder="e.g., FM">
                                    </div>
                                    <div class="col-md-7">
                                        <label for="new-call-long-name" class="form-label">Long Name (optional)</label>
                                        <input type="text" id="new-call-long-name" class="form-control" placeholder="e.g., Frequency Modulated">
                                    </div>
                                </div>
                                <button type="button" id="add-call-btn" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Add Call
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-end gap-2">
                    <a href="{% url 'battycoda_app:species_detail' species.id %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% load vite %}
<!-- Page data for species edit module -->
<script id="species-page-data" type="application/json">
{
    "mode": "edit",
    "currentSpeciesName": "{{ species.name|escapejs }}",
    "existingCalls": {{ existing_calls_json|safe }},
    "canModifyCalls": {{ can_modify|yesno:"true,false" }}
}
</script>

{% vite_asset 'static/js/species/index.js' %}
{% endblock %}