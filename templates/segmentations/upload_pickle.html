{% extends 'base.html' %}
{% load static %}
{% load vite %}

{% block title %}Upload Pickle File | {{ recording.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3>Upload Pickle File for Segmentation</h3>
                </div>
                <div class="card-body">
                    <h5 class="card-title">Recording: {{ recording.name }}</h5>
                    <p class="card-text">
                        Upload a pickle file containing onset and offset data to automatically create segments for this recording.
                    </p>
                    
                    {% if has_existing_segmentation %}
                    <div class="alert alert-info">
                        <strong>Note:</strong> This recording already has one or more segmentations. Uploading a pickle file will create an additional segmentation that you can switch between.
                    </div>
                    {% endif %}
                    
                    <div class="alert alert-info">
                        <strong>Pickle File Format Requirements:</strong>
                        <p>The uploaded pickle file should contain segment timestamps in one of these formats:</p>
                        <ul>
                            <li><strong>Dictionary format:</strong> <code>{"onsets": [0.1, 0.5, 1.2], "offsets": [0.3, 0.7, 1.5]}</code></li>
                            <li><strong>List/tuple format:</strong> <code>([0.1, 0.5, 1.2], [0.3, 0.7, 1.5])</code></li>
                        </ul>
                        <p>Each onset/offset pair (e.g., 0.1→0.3, 0.5→0.7) defines one segment in the recording.</p>
                        <p>Times should be in seconds and the number of onsets must match the number of offsets.</p>
                    </div>
                    
                    <form method="post" enctype="multipart/form-data" id="pickle-upload-form">
                        {% csrf_token %}
                        <div class="form-group mb-3">
                            <label for="pickle_file">Pickle File:</label>
                            <input type="file" name="pickle_file" id="pickle_file" class="form-control" required>
                        </div>

                        <!-- Upload Progress (shown when Vite file_upload module is active) -->
                        <div id="upload-progress-container" class="mb-3 d-none">
                            <div class="progress mb-2" class="h-25">
                                <div id="upload-progress-bar"
                                     class="progress-bar progress-bar-striped progress-bar-animated"
                                     role="progressbar"
                                     style="width: 0%"
                                     aria-valuenow="0"
                                     aria-valuemin="0"
                                     aria-valuemax="100">0%</div>
                            </div>
                            <div id="upload-status" class="text-muted small"></div>
                            <button type="button" id="cancel-upload" class="btn btn-sm btn-outline-danger mt-2 d-none">
                                <i class="fas fa-times"></i> Cancel Upload
                            </button>
                        </div>

                        <div class="d-flex justify-content-between">
                            {% if recording.segmentation %}
                                <a href="{% url 'battycoda_app:segmentation_detail' segmentation_id=recording.segmentation.id %}" class="btn btn-secondary">Cancel</a>
                            {% else %}
                                <a href="{% url 'battycoda_app:recording_detail' recording_id=recording.id %}" class="btn btn-secondary">Cancel</a>
                            {% endif %}
                            <button type="submit" class="btn btn-primary">Upload and Process</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
{% if VITE_FEATURES.file_upload %}
{% vite_asset 'static/js/file_upload/index.js' %}
{% endif %}
<script id="pickle-upload-data" type="application/json">
{
  "uploadUrl": "{% url 'battycoda_app:upload_pickle_segments' recording.id %}",
  "redirectUrl": "{% if recording.segmentation %}{% url 'battycoda_app:segmentation_detail' segmentation_id=recording.segmentation.id %}{% else %}{% url 'battycoda_app:recording_detail' recording_id=recording.id %}{% endif %}"
}
</script>
<script src="{% static 'js/pages/pickle-upload.js' %}"></script>
{% endblock %}