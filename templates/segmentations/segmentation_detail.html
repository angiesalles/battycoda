{% extends 'base.html' %}
{% load static %}
{% load django_vite %}
{% load battycoda_tags %}

{% block title %}BattyCoda - {{ active_segmentation.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/waveform_viewer.css' %}">
<link rel="stylesheet" href="{% static 'css/audio.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'battycoda_app:segmentation_list' %}">Segmentations</a></li>
                {% if recording.hidden %}
                    <li class="breadcrumb-item">{{ recording.name }}</li>
                {% else %}
                    <li class="breadcrumb-item"><a href="{% url 'battycoda_app:recording_detail' recording_id=recording.id %}">{{ recording.name }}</a></li>
                {% endif %}
                <li class="breadcrumb-item active" aria-current="page">{{ active_segmentation.name }}</li>
            </ol>
        </nav>
        <div class="d-flex">
            {% if recording.hidden %}
                <!-- Read-only preview mode - limited actions -->
                <span class="badge bg-info me-2 d-flex align-items-center">
                    <i class="fas fa-eye me-1"></i> Preview Mode
                </span>
                <button type="button" class="btn btn-outline-secondary" onclick="window.close();">
                    <i class="fas fa-times"></i> Close Preview
                </button>
            {% else %}
                <!-- Normal editing mode - full actions -->
                {% if active_segmentation %}
                <a id="create-classification-btn" href="{% url 'battycoda_app:create_classification_run_for_segmentation' segmentation_id=active_segmentation.id %}" class="btn btn-primary me-2" {% if not segments %}disabled{% endif %}>
                    <i class="fas fa-tag"></i> Create Classification
                </a>
                {% endif %}
                <a href="{% url 'battycoda_app:auto_segment_recording' recording_id=recording.id %}" class="btn btn-info me-2">
                    <i class="fas fa-magic"></i> Auto Segment
                </a>
                <a href="{% url 'battycoda_app:upload_pickle_segments' recording_id=recording.id %}" class="btn btn-outline-primary me-2">
                    <i class="fas fa-file-upload"></i> Upload Pickle
                </a>
                <a href="{% url 'battycoda_app:batch_segmentation' %}" class="btn btn-secondary me-2">
                    <i class="fas fa-tasks"></i> Segmentation Jobs
                </a>
                <form method="post" action="{% url 'battycoda_app:delete_segmentation' segmentation_id=segmentation.id %}" class="d-inline me-2" onsubmit="return confirm('Are you sure you want to delete this segmentation? This will delete all {{ total_segments_count }} segments and cannot be undone.');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger">
                        <i class="fas fa-trash"></i> Delete Segmentation
                    </button>
                </form>
                <a href="{% url 'battycoda_app:recording_detail' recording_id=recording.id %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Recording
                </a>
            {% endif %}
        </div>
    </div>

    {% if messages %}
    <div class="messages mb-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="row">
        <!-- Waveform and segmentation tools -->
        <div class="col-lg-8">
            <!-- Include the reusable waveform player with selection disabled for hidden recordings -->
            {% if recording.hidden %}
                {% include "recordings/includes/waveform_player.html" with recording=recording container_id="segment-waveform" height=300 allow_selection=False show_zoom=True segments=segments_json %}
            {% else %}
                {% include "recordings/includes/waveform_player.html" with recording=recording container_id="segment-waveform" height=300 allow_selection=True show_zoom=True segments=segments_json %}
            {% endif %}
        </div>
        
        <!-- Segments list -->
        <div class="col-lg-4">
            <!-- Include segments list component with read-only flag for hidden recordings -->
            {% include "segmentations/includes/segmentation/segments_list.html" with read_only=recording.hidden %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- CSRF token for AJAX requests -->
{% include 'includes/csrf_data.html' %}

{% vite_asset 'static/js/segmentation/index.js' %}

<script type="module">
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize segmentation manager
        const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;
        const segmentsData = {{ segments_json|safe }};
        
        // Check if this is a preview recording and auto-populate parameters
        const isHidden = {{ recording.hidden|yesno:"true,false" }};
        if (isHidden) {
            // This is a preview recording, check for stored parameters
            const storedParams = sessionStorage.getItem('segmentationPreviewParams');
            if (storedParams) {
                try {
                    const params = JSON.parse(storedParams);
                    
                    // Auto-populate form fields
                    const algorithmRadio = document.querySelector(`input[name="algorithm"][value="${params.algorithm}"]`);
                    if (algorithmRadio) algorithmRadio.checked = true;
                    
                    const minDuration = document.getElementById('min_duration_ms');
                    if (minDuration) minDuration.value = params.min_duration_ms;
                    
                    const smoothWindow = document.getElementById('smooth_window');
                    if (smoothWindow) smoothWindow.value = params.smooth_window;
                    
                    const thresholdFactor = document.getElementById('threshold_factor');
                    if (thresholdFactor) thresholdFactor.value = params.threshold_factor;
                    
                    const lowFreq = document.getElementById('low_freq');
                    if (lowFreq && params.low_freq) lowFreq.value = params.low_freq;
                    
                    const highFreq = document.getElementById('high_freq');
                    if (highFreq && params.high_freq) highFreq.value = params.high_freq;
                    
                    // Clear the stored parameters
                    sessionStorage.removeItem('segmentationPreviewParams');
                    
                    console.log('Auto-populated preview parameters:', params);
                } catch (e) {
                    console.error('Error parsing preview parameters:', e);
                }
            }
        }
        
        // Initialize segmentation
        const isReadOnly = {{ recording.hidden|yesno:"true,false" }};
        window.initSegmentation({
            recordingId: {{ recording.id }},
            segmentationId: {{ active_segmentation.id }},
            waveformId: 'segment-waveform',
            csrfToken: csrfToken,
            segments: segmentsData,
            containerId: 'segment-waveform-container',
            readOnly: isReadOnly,
            urls: {
                add: "{% url 'battycoda_app:add_segment' segmentation_id=active_segmentation.id %}",
                edit: "{% url_template 'battycoda_app:edit_segment' placeholders='segment_id' segmentation_id=active_segmentation.id %}",
                delete: "{% url_template 'battycoda_app:delete_segment' placeholders='segment_id' segmentation_id=active_segmentation.id %}"
            }
        });
    });
</script>
{% endblock %}