{% extends "base.html" %}
{% load static %}

{% block title %}Create Clustering Run - BattyCoda{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Create New Clustering Run</h3>
                <div class="btn-group float-right">
                    <a href="{% url 'battycoda_app:clustering_dashboard' %}" class="btn btn-secondary">
                        <i class="fa fa-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'battycoda_app:create_clustering_run' %}">
                    {% csrf_token %}
                    
                    <div class="form-group">
                        <label for="name">Run Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" name="name" required 
                               placeholder="Give your clustering run a descriptive name">
                        <small class="form-text text-muted">
                            A descriptive name to help you identify this clustering run.
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"
                                  placeholder="Optional description for this clustering run"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="segmentation">Segmentation <span class="text-danger">*</span></label>
                        <select class="form-control" id="segmentation" name="segmentation" required>
                            <option value="">Select a segmentation...</option>
                            {% for seg in segmentations %}
                            <option value="{{ seg.id }}">
                                {{ seg.recording.name }} - {{ seg.segments.count }} segments
                                {% if seg.is_active %} (Active) {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">
                            Select the segmentation containing the segments you want to cluster.
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="algorithm">Clustering Algorithm <span class="text-danger">*</span></label>
                        <select class="form-control" id="algorithm" name="algorithm" required>
                            <option value="">Select an algorithm...</option>
                            <optgroup label="ðŸ“Š Manual Algorithms (Specify cluster count)">
                                {% for algo in algorithms %}
                                {% if algo.algorithm_type == 'kmeans' or algo.algorithm_type == 'gaussian_mixture' or algo.algorithm_type == 'spectral' or algo.algorithm_type == 'dbscan' and 'Auto-Clustering' not in algo.name %}
                                <option value="{{ algo.id }}" data-type="{{ algo.algorithm_type }}" data-name="{{ algo.name }}">
                                    {{ algo.name }}
                                </option>
                                {% endif %}
                                {% endfor %}
                            </optgroup>
                            <optgroup label="ðŸ¤– Automatic Algorithms (Auto-determine clusters)">
                                {% for algo in algorithms %}
                                {% if 'Auto-Clustering' in algo.name %}
                                <option value="{{ algo.id }}" data-type="{{ algo.algorithm_type }}" data-name="{{ algo.name }}">
                                    {{ algo.name }}
                                </option>
                                {% endif %}
                                {% endfor %}
                            </optgroup>
                        </select>
                        <small class="form-text text-muted">
                            Choose between <strong>Manual algorithms</strong> (you specify cluster count) or <strong>Automatic algorithms</strong> (optimal clusters determined automatically).
                        </small>
                    </div>
                    
                    <div class="form-group" id="n_clusters_group">
                        <label for="n_clusters">Number of Clusters</label>
                        <input type="number" class="form-control" id="n_clusters" name="n_clusters" min="2" value="5">
                        <small class="form-text text-muted">
                            The target number of clusters to find. Only required for algorithms that need a predefined number 
                            of clusters (K-means, GMM, Spectral). Automatic algorithms will determine the optimal number.
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="feature_method">Feature Extraction Method</label>
                        <select class="form-control" id="feature_method" name="feature_method">
                            <option value="mfcc" selected>Mel-Frequency Cepstral Coefficients (MFCC)</option>
                            <option value="mel_spectrogram">Mel Spectrogram</option>
                            <option value="chroma">Chroma Features</option>
                        </select>
                        <small class="form-text text-muted">
                            The method used to extract features from the audio segments.
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">
                            <i class="fa fa-play"></i> Create Clustering Run
                        </button>
                        <a href="{% url 'battycoda_app:clustering_dashboard' %}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Show/hide number of clusters field based on algorithm type
    $('#algorithm').change(function() {
        const algorithmType = $(this).find(':selected').data('type');
        const algorithmName = $(this).find(':selected').data('name');
        
        // Algorithms that require manual cluster count specification
        const manualAlgorithms = ['kmeans', 'gaussian_mixture', 'spectral'];
        
        // Check if it's a manual algorithm OR if it's DBSCAN (but not Auto-DBSCAN)
        const isManualAlgorithm = manualAlgorithms.includes(algorithmType) || 
                                  (algorithmType === 'dbscan' && !algorithmName.includes('Auto-Clustering'));
        
        if (isManualAlgorithm) {
            $('#n_clusters_group').show();
            $('#n_clusters').attr('required', true);
        } else {
            $('#n_clusters_group').hide();
            $('#n_clusters').attr('required', false);
        }
    }).trigger('change');
});
</script>
{% endblock %}