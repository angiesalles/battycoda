// Handle view toggle between waveform and spectrogram
function setupViewToggle() {
    const waveformRadio = document.getElementById('{{ container_id }}-waveform-radio');
    const spectrogramRadio = document.getElementById('{{ container_id }}-spectrogram-radio');
    const viewLabel = document.getElementById('{{ container_id }}-view-label');
    const playerInstance = window.players["{{ container_id }}"];

    console.log('setupViewToggle - elements found:', {
        waveformRadio: !!waveformRadio,
        spectrogramRadio: !!spectrogramRadio,
        viewLabel: !!viewLabel,
        playerInstance: !!playerInstance
    });

    // Check if player instance is available
    if (!playerInstance || !playerInstance.setViewMode) {
        console.log('Player not ready, retrying...', { playerInstance: !!playerInstance, setViewMode: playerInstance?.setViewMode });
        // Retry after a short delay
        setTimeout(setupViewToggle, 100);
        return;
    }

    console.log('Player instance ready:', {
        isSpectrogramAvailable: playerInstance.isSpectrogramAvailable(),
        currentViewMode: playerInstance.getViewMode()
    });

    // If spectrogram is the default (checked), hide waveform immediately while loading
    if (spectrogramRadio.checked) {
        console.log('Spectrogram is default, hiding waveform immediately');
        const waveformCanvas = document.querySelector('#{{ container_id }} canvas.waveform-canvas');
        if (waveformCanvas) {
            waveformCanvas.style.display = 'none';
        }
    }

    function toggleView() {
        console.log('toggleView called - spectrogramRadio.checked:', spectrogramRadio.checked);
        console.log('Spectrogram available:', playerInstance.isSpectrogramAvailable());

        if (spectrogramRadio.checked) {
            // Switch to spectrogram view
            console.log('Switching to spectrogram view');
            playerInstance.setViewMode('spectrogram');
            viewLabel.textContent = 'Spectrogram';
        } else {
            // Switch to waveform view
            console.log('Switching to waveform view');
            playerInstance.setViewMode('waveform');
            viewLabel.textContent = 'Waveform';
        }
    }

    waveformRadio.addEventListener('change', toggleView);
    spectrogramRadio.addEventListener('change', toggleView);

    // Wait for spectrogram to be available before setting default view
    // Maximum wait time: 30 seconds (150 retries at 200ms each)
    const MAX_RETRIES = 150;
    let retryCount = 0;

    function trySetDefaultView() {
        if (playerInstance.isSpectrogramAvailable()) {
            console.log('Spectrogram available, setting default view to spectrogram');
            toggleView();
        } else {
            retryCount++;
            if (retryCount < MAX_RETRIES) {
                // Only log every 10 retries to reduce console spam
                if (retryCount % 10 === 0) {
                    console.log(`Spectrogram not available yet, retrying... (attempt ${retryCount}/${MAX_RETRIES})`);
                }
                setTimeout(trySetDefaultView, 200);
            } else {
                console.warn('Spectrogram not available after 30 seconds, staying on waveform view');
                // Ensure waveform is selected in the UI
                if (waveformRadio) {
                    waveformRadio.checked = true;
                    viewLabel.textContent = 'Waveform';
                }
            }
        }
    }

    // Initialize with spectrogram view (default) once it's available
    trySetDefaultView();
}

// Setup view toggle with retry mechanism
setupViewToggle();