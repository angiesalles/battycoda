{% extends "list_view_base.html" %}
{% load static %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/audio.css' %}">
<link rel="stylesheet" href="{% static 'css/waveform_viewer.css' %}">
{% endblock %}

{% block page_title %}Auto Segment{% endblock %}
{% block list_title %}Automated Segmentation{% endblock %}
{% block card_title %}{{ recording.name }}{% endblock %}

{% block action_buttons %}
{% if recording.segmentation %}
    <a href="{% url 'battycoda_app:segmentation_detail' segmentation_id=recording.segmentation.id %}" class="btn btn-secondary">
        <i class="fas fa-cut"></i> Manual Segmentation
    </a>
{% else %}
    <a href="{% url 'battycoda_app:create_segmentation' %}?recording={{ recording.id }}" class="btn btn-secondary">
        <i class="fas fa-cut"></i> Create Segmentation
    </a>
{% endif %}
<a href="{% url 'battycoda_app:recording_detail' recording_id=recording.id %}" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left"></i> Back to Recording
</a>
{% endblock %}

{% block data_table %}
<div class="mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'battycoda_app:recording_list' %}">Recordings</a></li>
            <li class="breadcrumb-item"><a href="{% url 'battycoda_app:recording_detail' recording_id=recording.id %}">{{ recording.name }}</a></li>
            {% if recording.segmentation %}
                <li class="breadcrumb-item"><a href="{% url 'battycoda_app:segmentation_detail' segmentation_id=recording.segmentation.id %}">Segment</a></li>
            {% endif %}
            <li class="breadcrumb-item active" aria-current="page">Auto Segment</li>
        </ol>
    </nav>
</div>

{% if existing_segmentation %}
<div class="alert alert-info mb-4">
    <i class="fas fa-info-circle"></i> 
    <strong>Note:</strong> This recording already has one or more segmentations. Running a new segmentation will create an additional segmentation that you can switch between.
</div>
{% endif %}

<div class="alert alert-info mb-4">
    <i class="fas fa-info-circle"></i> 
    {% if selected_algorithm %}
        <strong>{{ selected_algorithm.name }}</strong>: {{ selected_algorithm.description }}
    {% else %}
        {% if algorithms %}
            <strong>{{ algorithms.first.name }}</strong>: {{ algorithms.first.description }}
        {% else %}
            No segmentation algorithms are available.
        {% endif %}
    {% endif %}
</div>

{% if algorithms %}
<form method="post" action="{% url 'battycoda_app:auto_segment_recording' recording_id=recording.id %}" id="autoSegmentForm">
    {% csrf_token %}

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Choose Algorithm</h5>
                </div>
                <div class="card-body">
                    {% for algo in algorithms %}
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="algorithm" id="algorithm-{{ algo.id }}" 
                            value="{{ algo.id }}" {% if algo.id == selected_algorithm.id or forloop.first and not selected_algorithm %}checked{% endif %}>
                        <label class="form-check-label" for="algorithm-{{ algo.id }}">
                            <strong>{{ algo.name }}</strong>
                        </label>
                        <small class="d-block text-muted mt-1">{{ algo.description }}</small>
                    </div>
                    {% if not forloop.last %}<hr class="my-3">{% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Configure Parameters</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="min_duration_ms" class="form-label">Minimum Duration (ms):</label>
                        <input type="number" class="form-control" 
                            id="min_duration_ms" name="min_duration_ms" value="{{ min_duration_ms }}" 
                            min="1" max="1000" required>
                        <small class="form-text text-muted">Minimum segment duration in milliseconds. Shorter segments will be filtered out.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="smooth_window" class="form-label">Smoothing Window:</label>
                        <input type="number" class="form-control" 
                            id="smooth_window" name="smooth_window" value="{{ smooth_window }}" 
                            min="1" max="100" required>
                        <small class="form-text text-muted">Window size for the smoothing filter. Higher values create smoother detection but may miss short sounds.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="threshold_factor" class="form-label">Threshold Factor:</label>
                        <input type="number" class="form-control" 
                            id="threshold_factor" name="threshold_factor" value="{{ threshold_factor }}" 
                            min="0.1" max="10" step="0.1" required>
                        <small class="form-text text-muted">Factor used to calculate the threshold (mean + factor * std). Higher values = fewer segments detected.</small>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Bandpass Filter</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="low_freq" class="form-label">Low Frequency (Hz):</label>
                                <input type="number" class="form-control" 
                                    id="low_freq" name="low_freq" value="10000" 
                                    min="1" max="500000" step="1">
                                <small class="form-text text-muted">High-pass cutoff frequency</small>
                            </div>
                            <div class="col-md-6">
                                <label for="high_freq" class="form-label">High Frequency (Hz):</label>
                                <input type="number" class="form-control" 
                                    id="high_freq" name="high_freq" value="100000" 
                                    min="1000" max="500000" step="1">
                                <small class="form-text text-muted">Low-pass cutoff frequency</small>
                            </div>
                        </div>
                        <small class="form-text text-muted mt-1">
                            <i class="fas fa-info-circle"></i>
                            Bandpass filter applied before segmentation. Typical bat calls are 10-100 kHz. Leave empty to disable filtering.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endif %}

    <!-- No hidden fields needed since we're using the inputs directly -->
    
    <!-- Additional options and submit button -->
    <div class="card mt-4">
        <div class="card-header">
            <h5>Additional Options</h5>
        </div>
        <div class="card-body">
            
            <div class="text-end">
                <button type="submit" class="btn btn-primary" id="startSegmentationBtn">
                    <i class="fas fa-play"></i> Start Automated Segmentation
                </button>
            </div>
        </div>
    </div>
</form>

<!-- Preview Segmentation Section (separate from main form) -->
<div class="card mt-4">
    <div class="card-header">
        <h5>Preview Segmentation</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <label for="preview_start_time" class="form-label">Preview Start Time (seconds):</label>
                <input type="number" class="form-control" 
                    id="preview_start_time" name="preview_start_time" value="0" 
                    min="0" step="0.1">
                <small class="form-text text-muted">Start time for preview window</small>
            </div>
            <div class="col-md-6 d-flex align-items-end">
                <button type="button" class="btn btn-outline-info" id="previewBtn" data-recording-id="{{ recording.id }}">
                    <i class="fas fa-search"></i> Preview Segmentation
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Preview Results Display -->
<div class="card mt-4" id="previewResultsCard" style="display: none;">
    <div class="card-header">
        <h5>Segmentation Preview Results</h5>
    </div>
    <div class="card-body">
        <div id="previewResults">
            <!-- Waveform Visualization -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0"><span id="visualizationTitle">Spectrogram</span> with Detected Segments</h6>
                        <div class="btn-group btn-group-sm" role="group" aria-label="Visualization Type">
                            <button type="button" class="btn btn-outline-primary active" id="spectrogramToggle" data-type="spectrogram">
                                <i class="fas fa-chart-area"></i> Spectrogram
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="waveformToggle" data-type="waveform">
                                <i class="fas fa-wave-square"></i> Waveform
                            </button>
                        </div>
                    </div>
                    <div id="previewWaveformContainer" style="min-height: 250px; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 15px; background-color: #f8f9fa;">
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin"></i> Loading visualization...
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <label for="pitchControl" class="form-label">Pitch Shift:</label>
                                <input type="range" class="form-range" id="pitchControl" 
                                    min="0.5" max="2.0" step="0.1" value="1.0">
                                <small class="form-text text-muted">
                                    <span id="pitchValue">1.0x</span> (0.5x = -1 octave, 2.0x = +1 octave)
                                </small>
                            </div>
                            <div class="col-md-6">
                                <label for="volumeControl" class="form-label">Volume:</label>
                                <input type="range" class="form-range" id="volumeControl" 
                                    min="0.1" max="3.0" step="0.1" value="1.0">
                                <small class="form-text text-muted">
                                    <span id="volumeValue">1.0x</span>
                                </small>
                            </div>
                        </div>
                        <audio id="previewAudioPlayer" controls style="width: 100%; display: none;">
                            Your browser does not support the audio element.
                        </audio>
                    </div>
                </div>
            </div>
            
            <!-- Statistics and Segments -->
            <div class="row">
                <div class="col-md-6">
                    <h6>Preview Statistics</h6>
                    <p><strong>Algorithm:</strong> <span id="previewAlgorithm">-</span></p>
                    <p><strong>Time Range:</strong> <span id="previewTimeRange">-</span></p>
                    <p><strong>Segments Found:</strong> <span id="previewSegmentCount">0</span></p>
                    <p><strong>Segment Density:</strong> <span id="previewDensity">0</span> segments/second</p>
                    <p><strong>Avg Duration:</strong> <span id="previewAvgDuration">0</span> seconds</p>
                </div>
                <div class="col-md-6">
                    <h6>Detected Segments</h6>
                    <div id="previewSegmentsList" style="max-height: 200px; overflow-y: scroll;">
                        <!-- Segments will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status display area - hidden initially -->
<div class="card mt-4" id="statusCard" style="display: none;">
    <div class="card-header">
        <h5>Segmentation Status</h5>
    </div>
    <div class="card-body">
        <div id="statusMessage" class="alert alert-info">
            <i class="fas fa-spinner fa-spin"></i> Processing...
        </div>
        <div id="resultDetails" style="display: none;">
            <p><strong>Segments Created:</strong> <span id="segmentsCount">0</span></p>
            <p><strong>Processing Time:</strong> <span id="processingTime">-</span></p>
        </div>
        <div class="d-flex justify-content-between mt-3">
            <a href="{% url 'battycoda_app:batch_segmentation' %}" class="btn btn-secondary" id="viewAllJobsBtn">
                <i class="fas fa-tasks"></i> View All Segmentation Jobs
            </a>
            <a href="{% if recording.segmentation %}{% url 'battycoda_app:segmentation_detail' segmentation_id=recording.segmentation.id %}{% else %}{% url 'battycoda_app:create_segmentation' %}?recording={{ recording.id }}{% endif %}" class="btn btn-primary" id="viewSegmentsBtn" style="display: none;">
                <i class="fas fa-list"></i> View Segments
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Segmentation Preview Module -->
<script type="module" src="{% static 'js/segmentation_preview/index.js' %}"></script>
{% endblock %}