{% extends "list_view_base.html" %}
{% load static %}

{% block page_title %}Auto Segment{% endblock %}
{% block list_title %}Automated Segmentation{% endblock %}
{% block card_title %}{{ recording.name }}{% endblock %}

{% block action_buttons %}
<a href="{% url 'battycoda_app:segment_recording' recording_id=recording.id %}" class="btn btn-secondary">
    <i class="fas fa-cut"></i> Manual Segmentation
</a>
<a href="{% url 'battycoda_app:recording_detail' recording_id=recording.id %}" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left"></i> Back to Recording
</a>
{% endblock %}

{% block data_table %}
<div class="mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'battycoda_app:recording_list' %}">Recordings</a></li>
            <li class="breadcrumb-item"><a href="{% url 'battycoda_app:recording_detail' recording_id=recording.id %}">{{ recording.name }}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'battycoda_app:segment_recording' recording_id=recording.id %}">Segment</a></li>
            <li class="breadcrumb-item active" aria-current="page">Auto Segment</li>
        </ol>
    </nav>
</div>

<div class="alert alert-info mb-4">
    <i class="fas fa-info-circle"></i> 
    {% if selected_algorithm %}
        <strong>{{ selected_algorithm.name }}</strong>: {{ selected_algorithm.description }}
    {% else %}
        This tool automatically segments recordings by taking the absolute value of the audio signal,
        smoothing it using a moving average filter, applying a threshold to detect segments, and 
        rejecting segments shorter than the minimum duration.
    {% endif %}
</div>

{% if algorithms %}
<div class="card bg-dark mb-4">
    <div class="card-header">
        <h5>Choose Segmentation Algorithm</h5>
    </div>
    <div class="card-body">
        <div class="row">
            {% for algo in algorithms %}
            <div class="col-md-6 mb-3">
                <div class="card h-100 {% if algo.id == selected_algorithm.id %}border-primary{% endif %}">
                    <div class="card-header {% if algo.id == selected_algorithm.id %}bg-primary text-white{% endif %}">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="algorithm" id="algorithm-{{ algo.id }}" 
                                value="{{ algo.id }}" {% if algo.id == selected_algorithm.id %}checked{% endif %}>
                            <label class="form-check-label" for="algorithm-{{ algo.id }}">{{ algo.name }}</label>
                        </div>
                        <span class="badge bg-secondary float-end">{{ algo.get_algorithm_type_display }}</span>
                    </div>
                    <div class="card-body">
                        <p class="card-text small">{{ algo.description }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<div class="card bg-dark">
    <div class="card-header">
        <h5>Configure Segmentation Parameters</h5>
    </div>
    <div class="card-body">
        <form method="post" id="autoSegmentForm">
            {% csrf_token %}
            
            <!-- Hidden field for algorithm selection if none is selected in the cards above -->
            {% if selected_algorithm %}
            <input type="hidden" name="algorithm" value="{{ selected_algorithm.id }}" id="selected-algorithm-input">
            {% endif %}
            
            <div class="form-group row mb-3">
                <label for="min_duration_ms" class="col-sm-4 col-form-label">Minimum Duration (ms):</label>
                <div class="col-sm-8">
                    <input type="number" class="form-control bg-dark text-light border-secondary" id="min_duration_ms" name="min_duration_ms" 
                           value="{{ min_duration_ms }}" min="1" max="1000" required>
                    <small class="form-text text-muted">Minimum segment duration in milliseconds. Shorter segments will be filtered out.</small>
                </div>
            </div>
            
            <div class="form-group row mb-3">
                <label for="smooth_window" class="col-sm-4 col-form-label">Smoothing Window:</label>
                <div class="col-sm-8">
                    <input type="number" class="form-control bg-dark text-light border-secondary" id="smooth_window" name="smooth_window" 
                           value="{{ smooth_window }}" min="1" max="100" required>
                    <small class="form-text text-muted">Window size for the smoothing filter. Higher values create smoother detection but may miss short sounds.</small>
                </div>
            </div>
            
            <div class="form-group row mb-3">
                <label for="threshold_factor" class="col-sm-4 col-form-label">Threshold Factor:</label>
                <div class="col-sm-8">
                    <input type="number" class="form-control bg-dark text-light border-secondary" id="threshold_factor" name="threshold_factor" 
                           value="{{ threshold_factor }}" min="0.1" max="10" step="0.1" required>
                    <small class="form-text text-muted">Factor used to calculate the threshold (mean + factor * std). Higher values = fewer segments detected.</small>
                </div>
            </div>
            
            <div class="form-group row">
                <div class="col-sm-12 text-end">
                    <button type="submit" class="btn btn-primary" id="startSegmentationBtn">
                        <i class="fas fa-play"></i> Start Automated Segmentation
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Status display area - hidden initially -->
<div class="card bg-dark mt-4" id="statusCard" style="display: none;">
    <div class="card-header">
        <h5>Segmentation Status</h5>
    </div>
    <div class="card-body">
        <div id="statusMessage" class="alert alert-info">
            <i class="fas fa-spinner fa-spin"></i> Processing...
        </div>
        <div id="resultDetails" style="display: none;">
            <p><strong>Segments Created:</strong> <span id="segmentsCount">0</span></p>
            <p><strong>Processing Time:</strong> <span id="processingTime">-</span></p>
        </div>
        <div class="d-flex justify-content-between mt-3">
            <a href="{% url 'battycoda_app:batch_segmentation' %}" class="btn btn-secondary" id="viewAllJobsBtn">
                <i class="fas fa-tasks"></i> View All Segmentation Jobs
            </a>
            <a href="{% url 'battycoda_app:segment_recording' recording_id=recording.id %}" class="btn btn-primary" id="viewSegmentsBtn" style="display: none;">
                <i class="fas fa-list"></i> View Segments
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let taskStarted = false;
        let statusCheckInterval = null;
        
        // Handle algorithm selection change
        document.querySelectorAll("input[name='algorithm']").forEach(function(radio) {
            radio.addEventListener("change", function() {
                const algorithmId = this.value;
                
                // Update the hidden input in the form
                document.getElementById("selected-algorithm-input").value = algorithmId;
                
                // Highlight the selected algorithm card
                document.querySelectorAll(".card").forEach(function(card) {
                    card.classList.remove("border-primary");
                    card.querySelector(".card-header")?.classList.remove("bg-primary", "text-white");
                });
                
                this.closest(".card").classList.add("border-primary");
                this.closest(".card-header").classList.add("bg-primary", "text-white");
                
                // Fetch default parameters for the selected algorithm
                fetch(`{% url 'battycoda_app:auto_segment_recording' recording_id=recording.id %}?algorithm_id=${algorithmId}`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update form fields with default values
                        document.getElementById("min_duration_ms").value = data.min_duration_ms;
                        document.getElementById("smooth_window").value = data.smooth_window;
                        document.getElementById("threshold_factor").value = data.threshold_factor;
                        
                        // Update algorithm description
                        document.querySelector(".alert-info").innerHTML = `
                            <i class="fas fa-info-circle"></i> 
                            <strong>${data.algorithm_name}</strong>: ${data.algorithm_description}
                        `;
                    }
                })
                .catch(error => console.error('Error fetching algorithm defaults:', error));
            });
        });
        
        // Handle form submission via AJAX
        document.getElementById("autoSegmentForm").addEventListener("submit", function(e) {
            e.preventDefault();
            
            if (taskStarted) {
                return false; // Don't allow multiple submissions
            }
            
            // Show status area
            document.getElementById("statusCard").style.display = "block";
            document.getElementById("statusMessage").innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting automated segmentation...';
            document.getElementById("statusMessage").className = "alert alert-info";
            document.getElementById("resultDetails").style.display = "none";
            document.getElementById("viewSegmentsBtn").style.display = "none";
            
            // Disable form
            document.getElementById("startSegmentationBtn").disabled = true;
            
            // Get selected algorithm (if any)
            const algorithmId = document.querySelector("input[name='algorithm']:checked")?.value || 
                               document.getElementById("selected-algorithm-input")?.value;
            
            // Prepare URL for the AJAX request
            let url = "{% url 'battycoda_app:auto_segment_recording' recording_id=recording.id %}";
            if (algorithmId) {
                url = url + `?algorithm_id=${algorithmId}`;
            }
            
            // Create FormData from the form
            const formData = new FormData(this);
            
            // Send request
            fetch(url, {
                method: "POST",
                body: formData,
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                }
            })
            .then(response => response.json())
            .then(response => {
                if (response.success) {
                    taskStarted = true;
                    
                    // Update status message
                    document.getElementById("statusMessage").innerHTML = '<i class="fas fa-spinner fa-spin"></i> Segmentation in progress...';
                    
                    // Start polling for status
                    startStatusChecking();
                } else {
                    // Show error
                    document.getElementById("statusMessage").innerHTML = '<i class="fas fa-exclamation-triangle"></i> ' + (response.error || "Unknown error");
                    document.getElementById("statusMessage").className = "alert alert-danger";
                    document.getElementById("startSegmentationBtn").disabled = false;
                }
            })
            .catch(error => {
                // Show error
                document.getElementById("statusMessage").innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error: ' + error;
                document.getElementById("statusMessage").className = "alert alert-danger";
                document.getElementById("startSegmentationBtn").disabled = false;
            });
        });
        
        // Function to start checking status at regular intervals
        function startStatusChecking() {
            statusCheckInterval = setInterval(checkSegmentationStatus, 3000); // Check every 3 seconds
        }
        
        // Function to check segmentation status
        function checkSegmentationStatus() {
            fetch("{% url 'battycoda_app:auto_segment_status' recording_id=recording.id %}", {
                method: "GET",
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                }
            })
            .then(response => response.json())
            .then(response => {
                if (response.status === "completed") {
                    // Task completed successfully
                    clearInterval(statusCheckInterval);
                    
                    document.getElementById("statusMessage").innerHTML = '<i class="fas fa-check-circle"></i> ' + response.message;
                    document.getElementById("statusMessage").className = "alert alert-success";
                    
                    // Show results
                    document.getElementById("segmentsCount").textContent = response.segments_created || 0;
                    document.getElementById("processingTime").textContent = response.processing_time || '-';
                    
                    // Show the details
                    document.getElementById("resultDetails").style.display = "block";
                    document.getElementById("viewSegmentsBtn").style.display = "block";
                    
                    // Re-enable the form
                    document.getElementById("startSegmentationBtn").disabled = false;
                    taskStarted = false;
                } 
                else if (response.status === "failed") {
                    // Task failed
                    clearInterval(statusCheckInterval);
                    
                    document.getElementById("statusMessage").innerHTML = '<i class="fas fa-exclamation-triangle"></i> ' + response.message;
                    document.getElementById("statusMessage").className = "alert alert-danger";
                    
                    // Re-enable the form
                    document.getElementById("startSegmentationBtn").disabled = false;
                    taskStarted = false;
                }
                else if (response.status === "in_progress") {
                    // Still running - update message to show it's still working
                    document.getElementById("statusMessage").innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + response.message;
                }
                else if (response.status === "not_found") {
                    // No task found
                    clearInterval(statusCheckInterval);
                    
                    document.getElementById("statusMessage").innerHTML = '<i class="fas fa-question-circle"></i> ' + response.message;
                    document.getElementById("statusMessage").className = "alert alert-warning";
                    
                    // Re-enable the form
                    document.getElementById("startSegmentationBtn").disabled = false;
                    taskStarted = false;
                }
            })
            .catch(error => {
                // Show error but keep checking
                document.getElementById("statusMessage").innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error checking status: ' + error;
                document.getElementById("statusMessage").className = "alert alert-warning";
            });
        }
    });
</script>
{% endblock %}