{% extends 'list_view_base.html' %}
{% load static %}

{% block page_title %}{{ title }}{% endblock %}
{% block list_title %}{{ title }}{% endblock %}
{% block card_title %}{{ title }}{% endblock %}
{% block item_count %}{{ segmentation_jobs|length|default:"0" }}{% endblock %}

{% block action_buttons %}
<div class="d-flex gap-2 align-items-center">
    <!-- Project Filter -->
    <div class="me-3">
        <form method="get" class="d-flex align-items-center gap-2">
            <label for="project-filter" class="form-label mb-0 small text-muted">Filter by Project:</label>
            <select name="project" id="project-filter" class="form-select form-select-sm" onchange="this.form.submit()">
                <option value="">All Projects</option>
                {% for project in available_projects %}
                    <option value="{{ project.id }}" {% if project.id == selected_project_id %}selected{% endif %}>
                        {{ project.name }}
                    </option>
                {% endfor %}
            </select>
            {% if request.GET.page %}
                <input type="hidden" name="page" value="{{ request.GET.page }}">
            {% endif %}
        </form>
    </div>
    
    <!-- Action Buttons -->
    <a href="{% url 'battycoda_app:select_recording_for_segmentation' %}" class="btn btn-primary">
        <span class="s7-plus me-1"></span> New Segmentation Run
    </a>
</div>
{% endblock %}

{% block data_table %}
<!-- Debug Visualization Modal -->
<div class="modal fade" id="vizModal" tabindex="-1" aria-labelledby="vizModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="vizModalLabel">Segmentation Debug Visualization</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-center">
                <img id="vizImage" src="" alt="Debug Visualization" class="img-fluid">
                <p class="text-muted mt-3">
                    This visualization shows the segmentation process steps: 
                    original signal, absolute signal, smoothed signal with threshold, 
                    and binary mask with detected segments.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <a id="vizDownloadLink" href="" download class="btn btn-primary">
                    <span class="s7-download mr-1"></span> Download Image
                </a>
            </div>
        </div>
    </div>
</div>

<div id="segmentation-jobs-container">
    <div class="text-center py-4" id="loading-jobs">
        <div class="spinner-grow text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
        <p class="mt-2">Loading segmentations...</p>
{% include "recordings/includes/recording_selector.html" %}
{% include "recordings/includes/segmentation_params.html" %}
                            `;
                        }
                        
                        // Populate row cells
                        row.innerHTML = `
                            <td><a href="${job.view_url}" class="text-decoration-none">${job.recording_name}</a></td>
                            <td>${job.name || "Unnamed Segmentation"}</td>
                            <td><span data-utc-date="${job.start_time}" data-date-format="datetime">${new Date(job.start_time).toLocaleString()}</span></td>
                            <td>${statusBadge}</td>
                            <td><span class="badge badge-info">${job.segments_created || 0}</span></td>
                            <td>${progressBar}</td>
                            <td>
                                <div class="btn-group">
                                    ${actionsHtml}
                                </div>
                            </td>
                        `;
                        
                        jobsList.appendChild(row);
                    });
                    
                    // Initialize tooltips
                    $('[data-toggle="tooltip"]').tooltip();
                    
                    // Add click handlers for visualization badges
                    document.querySelectorAll('.viz-badge').forEach(function(badge) {
                        badge.addEventListener('click', function(e) {
                            e.preventDefault();
                            
                            // Get the visualization URL from the data attribute
                            const vizUrl = this.getAttribute('data-viz-url');
                            
                            // Set the image source in the modal
                            document.getElementById('vizImage').src = vizUrl;
                            
                            // Set the download link
                            document.getElementById('vizDownloadLink').href = vizUrl;
                            
                            // Show the modal
                            $('#vizModal').modal('show');
                        });
                    });
                }
            }
        } else {
            // Show empty state if it exists
            if (noJobsMessageElement) {
                noJobsMessageElement.style.display = 'block';
            }
        }
    }
</script>
{% endblock %}