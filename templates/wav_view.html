{% extends 'base.html' %}
{% load battycoda_tags %}
{% load static %}

{% block title %}BattyCoda - Vocalization Analysis - {{ wav_path }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/waveform_viewer.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-3 waveform-viewer">

    <div class="grid-container">
        <!-- Spectrogram section with labels -->
        <div class="spectrogram-section">
            <h3>Spectrogram: <span id="current-call-text">1</span> of <span id="total-calls-text">{{ total_calls }}</span> calls</h3>
            <div id="spectrogram-container" class="mb-3">
                <!-- Spectrogram with axes -->
                <div class="d-flex">
                    <!-- Y-axis labels -->
                    <div class="spectrogram-y-axis">
                        <div class="axis-label" style="writing-mode: vertical-rl; transform: rotate(180deg); text-align: center; margin-right: 5px;">
                            Frequency (kHz)
                        </div>
                        <div class="y-tick-marks">
                            <div class="y-tick">250</div>
                            <div class="y-tick">200</div>
                            <div class="y-tick">150</div>
                            <div class="y-tick">100</div>
                            <div class="y-tick">50</div>
                            <div class="y-tick">0</div>
                        </div>
                    </div>
                    
                    <!-- Spectrogram and X-axis -->
                    <div style="flex: 1;">
                        <!-- Spectrogram image -->
                        <div class="spectrogram-container" style="text-align: center; position: relative; height: 400px;">
                            <img id="spectrogram" alt="Spectrogram" style="max-width: 100%; height: 100%; object-fit: contain;">
                        </div>
                        
                        <!-- X-axis labels -->
                        <div class="spectrogram-x-axis">
                            <div class="x-tick-marks">
                                <div class="x-tick">0</div>
                                <div class="x-tick">10</div>
                                <div class="x-tick">20</div>
                                <div class="x-tick">30</div>
                                <div class="x-tick">40</div>
                                <div class="x-tick">50</div>
                            </div>
                            <div class="d-flex justify-content-center">
                                <div class="axis-label">Time (ms)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Controls section -->
        <div class="controls">
            <div class="mb-2">
                <label for="contrast">Contrast:</label>
                <input type="text" id="contrast" name="contrast" class="form-control" value="4.0">
            </div>
            <div class="mb-2">
                <label for="loudness">Loudness:</label>
                <input type="text" id="loudness" name="loudness" class="form-control" value="1.0">
            </div>
            <div class="mb-2">
                <label for="channel-selector">Main channel:</label>
                <select class="form-select" id="channel-selector">
                    <option value="0">Channel 1</option>
                    <option value="1">Channel 2</option>
                </select>
            </div>
            
            <div class="button-group mt-3">
                <button class="btn btn-primary" id="prev-call-btn">Previous Call</button>
                <button class="btn btn-primary" id="next-call-btn">Next Call</button>
                <button class="btn btn-secondary" id="update-btn">Update View</button>
            </div>
            
            <div class="mt-3">
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-secondary" id="overview-btn">Overview</button>
                    <button class="btn btn-outline-secondary active" id="detail-btn">Detail</button>
                </div>
            </div>
        </div>
        
        <!-- Call type section -->
        <div class="call-type">
            <h3>Vocalization Classification</h3>
            
            <div class="mb-3">
                <p><strong>Species:</strong> {{ species }}</p>
            </div>
            
            <!-- Dynamic call types from the species text file -->
            {% if call_types %}
                {% for call_type in call_types %}
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" id="{{ call_type|slugify }}" name="type_call" value="{{ call_type }}">
                    <label class="form-check-label" for="{{ call_type|slugify }}">
                        {{ call_type }}
                    </label>
                </div>
                {% endfor %}
            {% else %}
                <!-- Default options if no call types found -->
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" id="correct" name="type_call" value="correct">
                    <label class="form-check-label" for="correct">Correctly classified</label>
                </div>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" id="Unsure" name="type_call" value="Unsure">
                    <label class="form-check-label" for="Unsure">Unsure</label>
                </div>
            {% endif %}
            
            <!-- Unknown option before Other -->
            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" id="Unknown" name="type_call" value="Unknown" checked>
                <label class="form-check-label" for="Unknown">Unknown</label>
            </div>
            
            <!-- Always include Other option -->
            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" id="Other" name="type_call" value="">
                <label class="form-check-label" for="Other">Other:</label>
                <input type="text" class="form-control mt-1" id="other-input" name="other_call">
            </div>
        </div>
        
        <!-- Removed large spectrogram section -->
        
        <!-- Confidence section -->
        <div class="confidence">
            <h3>Classification Confidence</h3>
            <p>Confidence: <strong id="confidence-value">--</strong></p>
            
            <div class="mb-3">
                <label for="limit_confidence">If future confidence is below this ask:</label>
                <input type="number" min="0" max="100" step="1" id="limit_confidence" 
                    name="limit_confidence" value="80" class="form-control">
            </div>
            
            <div class="mt-3">
                <p>Species template:</p>
                <div id="species-template-container">
                    <!-- Only show species template if available -->
                    {% if species %}
                    <img id="species-template" class="img-fluid" alt="Species Template" 
                         src="{% static species|add:'.jpg' %}"
                         onerror="this.style.display='none'; this.parentNode.innerHTML += '<div class=\'text-muted\'>No template image available</div>'">
                    {% else %}
                    <div class="text-muted">No species selected</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Audio section -->
        <div class="audio-section">
            <h3>Audio Playback</h3>
            <div class="mt-2">
                <p>Short clip:</p>
                <audio controls id="audio-player" preload="none" class="w-100">
                    Your browser does not support the audio element.
                </audio>
            </div>
            
            <div class="mt-3">
                <p>Long clip:</p>
                <audio controls id="audio-player-long" preload="none" class="w-100">
                    Your browser does not support the audio element.
                </audio>
            </div>
        </div>
        
        <!-- Other channels section -->
        <div class="others">
            <h3>Other Channels</h3>
            <div class="other-channels-content" id="other-channels-container">
                <!-- Will be filled dynamically -->
            </div>
        </div>
    </div>

    <div class="mt-4 mb-3 p-3 rounded shadow-sm" style="background-color: #262626;">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <small class="text-light">{{ species }} - {{ wav_path }}</small>
            </div>
            <div>
                <button class="btn btn-primary me-2" id="save-changes-btn">Save Changes</button>
                <button class="btn btn-outline-light" id="export-csv-btn">Export CSV</button>
            </div>
        </div>
    </div>
</div>

<!-- Configuration data for waveform viewer -->
<script>
    var wavViewerConfig = {
        wavPath: "{{ full_path }}",
        fileHash: "{{ file_hash }}",
        totalCalls: {{ total_calls }},
        spectrogramUrl: "{% url 'battycoda_app:spectrogram' %}",
        audioUrl: "{% url 'battycoda_app:audio_snippet' %}"
    };
</script>

<!-- Include waveform viewer JavaScript -->
<script src="{% static 'js/waveform_player.js' %}"></script>
<script src="{% static 'js/waveform_viewer.js' %}"></script>
{% endblock %}