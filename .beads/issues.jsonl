{"id":"battycoda-013","title":"Phase 3: Quality Improvements","description":"## Scope\nCode quality improvements for clustering visualization.\n\n## Tasks (from CLUSTERING_VISUALIZATION_OVERHAUL.md)\n\n### 1. Remove console.log statements (~30+)\nLocations: drag_drop.js, mapping_interface.js, create_run.html\nOption: Remove all or use DEBUG flag pattern\n\n### 2. Add debouncing\n- Cluster search: cluster_mapping.js:26\n- Confidence slider: initialization.js:74\nPattern: debounce(fn, 300)\n\n### 3. Use Django json_script for data serialization\nCurrent (fragile):\n```javascript\n{% for cluster in clusters %}\nclusters.push({...});\n{% endfor %}\n```\nBetter:\n```html\n{{ clusters_data|json_script:\"clusters-data\" }}\n```\n\n### 4. Standardize API response format\nCurrent mix:\n- {'status': 'success', 'data': ...}\n- {'error': 'message'}\n- {'status': 'error', 'message': '...'}\n\n### 5. Extract inline JS to external files\n- create_run.html: 130+ lines\n- dashboard.html: 30+ lines  \n- cluster_explorer.html: 20+ lines\n\n### 6. Hardcoded URLs → Django url tag\nPass URLs from template to JS\n\n## Estimated Effort\n16-24 hours","status":"open","priority":2,"issue_type":"epic","owner":"boergens@uic.edu","created_at":"2026-01-13T22:19:48.547351295Z","created_by":"Kevin Boergens","updated_at":"2026-01-13T22:19:48.547351295Z"}
{"id":"battycoda-nfp","title":"Phase 4: Performance","description":"## Scope\nPerformance optimizations for clustering system.\n\n## Tasks (from CLUSTERING_VISUALIZATION_OVERHAUL.md)\n\n### 1. Fix N+1 Query in export_clusters\nLocation: mappings.py:46-58\nProblem:\n```python\nfor sc in segment_clusters:\n    segment = sc.segment  # Query\n    recording = segment.segmentation.recording  # Query\n```\nFix: Use select_related properly\n\n### 2. Streaming CSV exports\nLocation: mappings.py:14-62\nProblem: Large exports build entire CSV in memory\nFix: Use StreamingHttpResponse with generator\n\n### 3. Add pagination\nAffected areas:\n- Dashboard (all runs shown)\n- Cluster members list\n- Segment lists\n\n## Estimated Effort\n4-8 hours","status":"open","priority":3,"issue_type":"epic","owner":"boergens@uic.edu","created_at":"2026-01-13T22:23:32.098076139Z","created_by":"Kevin Boergens","updated_at":"2026-01-13T22:23:32.098076139Z"}
{"id":"battycoda-qky","title":"Phase 2: Architecture Refactor","description":"## Scope\nRefactor clustering JS/CSS architecture for maintainability.\n\n## Tasks (from CLUSTERING_VISUALIZATION_OVERHAUL.md)\n1. Consolidate 3 JS loading patterns into single IIFE pattern\n2. Create centralized ClusteringApp state management object\n3. Extract permission checks to decorator/mixin in views_clustering/\n4. Consolidate duplicate CSS (cluster_explorer.css + mapping_interface.css → clustering.css)\n\n## Details\n\n### JS Loading Patterns to Consolidate\n- cluster_explorer.js: Custom dynamic script loader\n- cluster_mapping.js: ES6 imports (broken)\n- mapping_interface.js: setTimeout + script injection\n\n### State Variables to Centralize\n- selectedClusterId (in 3+ files)\n- clusters array\n- clusteringRunId\n\n### Permission Check Pattern (repeated 12+ times)\n```python\nif not request.user.is_staff:\n    if clustering_run.group and clustering_run.group != request.user.profile.group:\n        return JsonResponse({'status': 'error', ...})\n```\n\n## Estimated Effort\n8-16 hours","status":"open","priority":2,"issue_type":"epic","owner":"boergens@uic.edu","created_at":"2026-01-13T22:14:59.290027423Z","created_by":"Kevin Boergens","updated_at":"2026-01-13T22:14:59.290027423Z"}
{"id":"battycoda-yf0","title":"Clustering Visualization Overhaul","description":"## Overview\nComplete overhaul of the clustering visualization system. The current implementation has multiple critical bugs that prevent basic functionality from working.\n\nSee CLUSTERING_VISUALIZATION_OVERHAUL.md for the full analysis including:\n- Red team review findings\n- Architecture issues  \n- Quality improvements needed\n- Accessibility gaps\n\n## Critical Path (Priority Order)\n1. yf0.1 - Fix base.html extra_js placement (affects ALL clustering pages)\n2. yf0.2 - Fix create_run.html script block (can't create new runs)\n3. yf0.3 - Fix ES6 modules (mapping interface completely broken)\n4. yf0.4 - Fix delete URL mismatch (depends on yf0.3)\n5. yf0.5 - Remove duplicate handlers (causes double API calls)\n\n## Testing Checklist\nAfter all fixes:\n- [ ] /clustering/ dashboard loads, auto-refresh works\n- [ ] /clustering/create/ form is interactive\n- [ ] /clustering/run/\u003cid\u003e/ progress updates\n- [ ] /clustering/explorer/\u003cid\u003e/ visualization renders\n- [ ] /clustering/mapping/\u003cid\u003e/ drag-drop works, delete works\n\n## Future Work (not in this epic)\n- Consolidate JS to single loading pattern\n- Add proper error handling\n- Fix Bootstrap 4/5 class inconsistencies\n- Add keyboard navigation\n- Accessibility improvements","status":"open","priority":1,"issue_type":"epic","owner":"boergens@uic.edu","created_at":"2026-01-13T21:48:05.19951375Z","created_by":"Kevin Boergens","updated_at":"2026-01-13T22:03:06.936402762Z"}
{"id":"battycoda-yf0.1","title":"Fix base.html: Move extra_js block after jQuery","description":"## Problem\nIn templates/base.html, the {% block extra_js %} is at line 211, but jQuery loads at line 214.\nAny template with inline $(document).ready() in extra_js fails with 'ReferenceError: $ is not defined'.\n\n## Affected Templates\n- clustering/dashboard.html - auto-refresh broken\n- clustering/run_detail.html - progress polling broken\n\n## Fix\nMove line 211 (`{% block extra_js %}{% endblock %}`) to AFTER line 227 (after all core scripts including jQuery, Bootstrap, app.js, etc.)\n\n## Verification\n1. After fix, visit /clustering/ and check browser console for JS errors\n2. Create a clustering run and verify progress auto-refresh works","status":"open","priority":0,"issue_type":"task","owner":"boergens@uic.edu","created_at":"2026-01-13T21:48:52.207508074Z","created_by":"Kevin Boergens","updated_at":"2026-01-13T22:01:52.327047038Z","dependencies":[{"issue_id":"battycoda-yf0.1","depends_on_id":"battycoda-yf0","type":"parent-child","created_at":"2026-01-13T21:48:52.210986439Z","created_by":"Kevin Boergens"}]}
{"id":"battycoda-yf0.2","title":"Fix create_run.html: Move script inside template block","description":"## Problem\nIn templates/clustering/create_run.html, lines 244-374 contain a \u003cscript\u003e block that is placed AFTER {% endblock %} (line 242).\n\nDjango template inheritance ignores content outside blocks, so this 130-line script is NEVER rendered.\n\n## Impact\nAll interactivity on the create clustering run page is broken:\n- Scope toggle (single recording vs project)\n- Project/species selection AJAX\n- Algorithm type detection (manual vs auto)\n- Form validation\n\n## Fix\n1. Add {% block extra_js %} before line 244\n2. Add {% endblock %} after line 374\n3. Or move the script inside the existing content block\n\n## Code Change\n```html\n\u003c!-- Line 242 currently --\u003e\n{% endblock %}\n\n\u003cscript\u003e  \u003c!-- THIS NEVER RENDERS --\u003e\n\n\u003c!-- Should be: --\u003e\n{% endblock %}\n\n{% block extra_js %}\n\u003cscript\u003e\n...\n\u003c/script\u003e\n{% endblock %}\n```\n\n## Verification\n1. Visit /clustering/create/\n2. Toggle between 'Single Recording' and 'Entire Project' - should animate\n3. Select a project - should fetch species via AJAX\n4. Select an algorithm - should show/hide cluster count field","status":"open","priority":0,"issue_type":"task","owner":"boergens@uic.edu","created_at":"2026-01-13T21:48:52.292853184Z","created_by":"Kevin Boergens","updated_at":"2026-01-13T22:02:05.491461424Z","dependencies":[{"issue_id":"battycoda-yf0.2","depends_on_id":"battycoda-yf0","type":"parent-child","created_at":"2026-01-13T21:48:52.295966283Z","created_by":"Kevin Boergens"}]}
{"id":"battycoda-yf0.3","title":"Fix ES6 module loading in cluster_mapping.js","description":"## Problem\nstatic/js/cluster_mapping.js uses ES6 import statements but is loaded as a regular script (not type='module').\n\nFiles using ES6 syntax:\n- static/js/cluster_mapping.js (line 7-10: import statements)\n- static/js/cluster_mapping/initialization.js (export statements)\n- static/js/cluster_mapping/drag_drop.js (export statements)\n- static/js/cluster_mapping/modal_handlers.js (export statements)\n- static/js/cluster_mapping/filtering.js (export statements)\n\n## Impact\nThe entire cluster mapping interface is broken. Browser throws SyntaxError on import statements.\n\n## Fix Options\n\n### Option A: Convert to IIFE pattern (Recommended - no build tools needed)\n1. Remove all import/export statements\n2. Wrap each module in an IIFE\n3. Attach functions to a global ClusterMapping namespace\n4. Load scripts in dependency order in the template\n\n### Option B: Add type='module' \n1. In mapping_interface.html, change script loading to use type='module'\n2. Ensure all import paths are correct (may need .js extensions)\n3. Note: This changes how scripts load and may have side effects\n\n## Files to Modify\n- static/js/cluster_mapping.js\n- static/js/cluster_mapping/initialization.js\n- static/js/cluster_mapping/drag_drop.js\n- static/js/cluster_mapping/modal_handlers.js\n- static/js/cluster_mapping/filtering.js\n- templates/clustering/mapping_interface.html (if using Option B)\n\n## Verification\n1. Visit /clustering/mapping/\u003crun_id\u003e/ for a completed clustering run\n2. Check browser console - should have no SyntaxError\n3. Drag a cluster to a call type - should create mapping\n4. Delete a mapping - should work (also tests yf0.4)","status":"open","priority":0,"issue_type":"task","owner":"boergens@uic.edu","created_at":"2026-01-13T21:48:52.376442449Z","created_by":"Kevin Boergens","updated_at":"2026-01-13T22:02:20.07540135Z","dependencies":[{"issue_id":"battycoda-yf0.3","depends_on_id":"battycoda-yf0","type":"parent-child","created_at":"2026-01-13T21:48:52.378633343Z","created_by":"Kevin Boergens"}]}
{"id":"battycoda-yf0.4","title":"Fix URL mismatch: delete-mapping endpoint","description":"## Problem\nURL mismatch between Python backend and JavaScript frontend for delete mapping endpoint.\n\nPython (clustering_urls.py line 23):\n  path('clustering/delete-mapping/', ...)\n\nJavaScript (static/js/cluster_mapping/drag_drop.js line 186):\n  url: '/clustering/delete-cluster-mapping/'\n\n## Impact\nDeleting cluster mappings fails with 404 error. Users cannot remove mappings once created.\n\n## Fix\nChange drag_drop.js line 186 from:\n  url: '/clustering/delete-cluster-mapping/',\nto:\n  url: '/clustering/delete-mapping/',\n\n## Alternative Fix\nCould change Python URL instead, but JS fix is simpler and matches the naming pattern of other endpoints (create-mapping, update-mapping-confidence).\n\n## Related URLs (verified correct)\n- /clustering/create-mapping/ ✓\n- /clustering/update-mapping-confidence/ ✓\n- /clustering/delete-mapping/ ← JS needs to match this\n\n## Verification\n1. Go to mapping interface for a completed clustering run\n2. Create a test mapping (drag cluster to call type)\n3. Click the X button to delete the mapping\n4. Should succeed (check Network tab - should be 200, not 404)\n\n## Note\nThis fix depends on yf0.3 (ES6 modules) being fixed first, otherwise the JS won't even load.","status":"open","priority":0,"issue_type":"task","owner":"boergens@uic.edu","created_at":"2026-01-13T21:48:52.453264548Z","created_by":"Kevin Boergens","updated_at":"2026-01-13T22:02:32.5981316Z","dependencies":[{"issue_id":"battycoda-yf0.4","depends_on_id":"battycoda-yf0","type":"parent-child","created_at":"2026-01-13T21:48:52.455332083Z","created_by":"Kevin Boergens"},{"issue_id":"battycoda-yf0.4","depends_on_id":"battycoda-yf0.3","type":"blocks","created_at":"2026-01-13T22:03:14.404435334Z","created_by":"Kevin Boergens"}]}
{"id":"battycoda-yf0.5","title":"Remove duplicate event handlers","description":"## Problem\nEvent handlers are registered twice for the same elements, causing double API calls and potential race conditions.\n\n### Duplicate 1: #save-cluster-label click\n- static/js/cluster_explorer/visualization.js line 21\n- static/js/cluster_explorer/controls.js line 46\n\n### Duplicate 2: .view-segment-btn click  \n- static/js/cluster_explorer/visualization.js line 28\n- static/js/cluster_explorer/controls.js line 51\n\n## Impact\n- Clicking 'Save' on cluster label triggers two API calls\n- Clicking 'View' on segment triggers two modal loads\n- Race conditions may cause inconsistent UI state\n\n## Fix\nRemove the duplicate handlers from controls.js (lines 46-54), keeping them in visualization.js.\n\nOr alternatively, remove from visualization.js and keep in controls.js - just pick one location.\n\n## Code to Remove (controls.js lines 44-55)\n```javascript\n// DELETE THESE LINES:\n.ready(function() {\n    // Handle save button click\n    $('#save-cluster-label').click(function() {\n        saveClusterLabel();\n    });\n\n    // Handle segment view button click\n    $(document).on('click', '.view-segment-btn', function() {\n        const segmentId = $(this).data('segment-id');\n        loadSegmentDetails(segmentId);\n    });\n    // ... keep the rest (point-size, cluster-opacity handlers)\n});\n```\n\n## Verification\n1. Go to cluster explorer for a completed run\n2. Select a cluster, edit the label, click Save\n3. Check Network tab - should see only ONE POST request\n4. Click 'View' on a segment - should see only ONE GET request","status":"open","priority":1,"issue_type":"task","owner":"boergens@uic.edu","created_at":"2026-01-13T21:48:52.533134397Z","created_by":"Kevin Boergens","updated_at":"2026-01-13T22:02:51.382394165Z","dependencies":[{"issue_id":"battycoda-yf0.5","depends_on_id":"battycoda-yf0","type":"parent-child","created_at":"2026-01-13T21:48:52.535484439Z","created_by":"Kevin Boergens"}]}
{"id":"battycoda-yf0.6","title":"Verify loading spinner fix in visualization.js","description":"## Problem\nIn static/js/cluster_explorer/visualization.js, when clusters exist, the code only removed existing SVG elements but not the loading spinner div.\n\n## Partial Fix Applied\nChanged line ~50 from:\n  d3.select('#cluster-visualization svg').remove();\nto:\n  $('#cluster-visualization').empty();\n\n## Status\nPartial fix was applied but needs verification after yf0.1 (base.html fix) is done.\n\n## Location\n- static/js/cluster_explorer/visualization.js (around line 44-56)\n- templates/clustering/cluster_explorer.html (spinner HTML)\n\n## Verification\n1. Complete yf0.1 first (extra_js fix)\n2. Run collectstatic\n3. Visit /clustering/explorer/\u003crun_id\u003e/ for a completed run\n4. Verify visualization renders (no infinite spinner)\n5. Check browser console for errors","status":"open","priority":1,"issue_type":"task","owner":"boergens@uic.edu","created_at":"2026-01-13T22:13:04.104183097Z","created_by":"Kevin Boergens","updated_at":"2026-01-13T22:13:04.104183097Z","dependencies":[{"issue_id":"battycoda-yf0.6","depends_on_id":"battycoda-yf0","type":"parent-child","created_at":"2026-01-13T22:13:04.108574366Z","created_by":"Kevin Boergens"},{"issue_id":"battycoda-yf0.6","depends_on_id":"battycoda-yf0.1","type":"blocks","created_at":"2026-01-13T22:14:41.706480628Z","created_by":"Kevin Boergens"}]}
{"id":"battycoda-zic","title":"Phase 5: New Features","description":"## Scope\nFeature additions for clustering visualization.\n\n## Tasks (from CLUSTERING_VISUALIZATION_OVERHAUL.md)\n\n### 1. Keyboard navigation for cluster explorer\n- Arrow keys to navigate clusters\n- Enter to select\n- Escape to deselect\n- Tab navigation\n\n### 2. Zoom reset button\nLocation: Cluster explorer D3 visualization\nAdd button to reset zoom to default view\n\n### 3. Bulk operations for mapping\nCurrent: Must map clusters one-by-one\nAdd: Multi-select and bulk mapping\n\n### 4. Improved error handling\nCurrent: Generic 'Failed to...' messages\nAdd: Retry buttons, specific error messages\n\n### 5. Cluster comparison view (optional)\nSide-by-side comparison of two clusters\n\n## Estimated Effort\n16-24 hours","status":"open","priority":3,"issue_type":"epic","owner":"boergens@uic.edu","created_at":"2026-01-13T22:24:39.577207816Z","created_by":"Kevin Boergens","updated_at":"2026-01-13T22:24:39.577207816Z"}
